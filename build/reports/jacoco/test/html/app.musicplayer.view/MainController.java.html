<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MusicPlayerTest</a> &gt; <a href="index.source.html" class="el_package">app.musicplayer.view</a> &gt; <span class="el_source">MainController.java</span></div><h1>MainController.java</h1><pre class="source lang-java linenums">package app.musicplayer.view;

import java.net.URL;
import java.util.Optional;
import java.util.ResourceBundle;
import java.util.concurrent.CountDownLatch;

import app.musicplayer.model.*;
import app.musicplayer.util.Search;
import com.melloware.jintellitype.IntellitypeListener;
import com.melloware.jintellitype.JIntellitype;

import app.musicplayer.MusicPlayer;
import app.musicplayer.util.CustomSliderSkin;
import app.musicplayer.util.Resources;
import app.musicplayer.util.SubView;
import javafx.animation.Animation;
import javafx.animation.Animation.Status;
import javafx.animation.Interpolator;
import javafx.animation.Transition;
import javafx.application.Platform;
import javafx.collections.ObservableList;
import javafx.concurrent.Task;
import javafx.css.PseudoClass;
import javafx.event.Event;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.fxml.Initializable;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Node;
import javafx.scene.Scene;
import javafx.scene.SnapshotParameters;
import javafx.scene.control.*;
import javafx.scene.image.ImageView;
import javafx.scene.input.ClipboardContent;
import javafx.scene.input.Dragboard;
import javafx.scene.input.KeyCode;
import javafx.scene.input.TransferMode;
import javafx.scene.layout.HBox;
import javafx.scene.layout.Pane;
import javafx.scene.layout.Region;
import javafx.scene.layout.VBox;
import javafx.scene.transform.Transform;
import javafx.stage.Stage;
import javafx.stage.StageStyle;
import javafx.util.Duration;

<span class="nc" id="L49">public class MainController implements Initializable, IntellitypeListener {</span>

<span class="nc" id="L51">	private boolean isSideBarExpanded = true;</span>
<span class="nc" id="L52">    private double expandedWidth = 250;</span>
<span class="nc" id="L53">    private double collapsedWidth = 50;</span>
<span class="nc" id="L54">    private double expandedHeight = 50;</span>
<span class="nc" id="L55">    private double collapsedHeight = 0;</span>
<span class="nc" id="L56">	private double searchExpanded = 180;</span>
<span class="nc" id="L57">	private double searchCollapsed = 0;</span>
    private SubView subViewController;
    private CustomSliderSkin sliderSkin;
    private Stage volumePopup;
    private Stage searchPopup;
    private VolumePopupController volumePopupController;
    private CountDownLatch viewLoadedLatch;

    @FXML private ScrollPane subViewRoot;
    @FXML private VBox sideBar;
    @FXML private VBox playlistBox;
    @FXML private ImageView nowPlayingArtwork;
    @FXML private Label nowPlayingTitle;
    @FXML private Label nowPlayingArtist;
    @FXML private Slider timeSlider;
    @FXML private Region frontSliderTrack;    
    @FXML private Label timePassed;
    @FXML private Label timeRemaining;

    @FXML private HBox letterBox;
    @FXML private Separator letterSeparator;

    @FXML private Pane playButton;
    @FXML private Pane pauseButton;
    @FXML private Pane loopButton;
    @FXML private Pane shuffleButton;
    @FXML private HBox controlBox;

	@FXML private TextField searchBox;

    @Override
    public void initialize(URL location, ResourceBundle resources) {
    	
<span class="nc" id="L90">    	resetLatch();</span>
    	
<span class="nc" id="L92">    	controlBox.getChildren().remove(2);</span>
    	
<span class="nc" id="L94">    	frontSliderTrack.prefWidthProperty().bind(timeSlider.widthProperty().multiply(timeSlider.valueProperty().divide(timeSlider.maxProperty())));</span>
    	
<span class="nc" id="L96">    	sliderSkin = new CustomSliderSkin(timeSlider);</span>
<span class="nc" id="L97">    	timeSlider.setSkin(sliderSkin);</span>
    	
<span class="nc" id="L99">    	createVolumePopup();</span>
<span class="nc" id="L100">        createSearchPopup();</span>
    	
<span class="nc" id="L102">    	PseudoClass active = PseudoClass.getPseudoClass(&quot;active&quot;);</span>
<span class="nc" id="L103">    	loopButton.setOnMouseClicked(x -&gt; {</span>
<span class="nc" id="L104">    		sideBar.requestFocus();</span>
<span class="nc" id="L105">    		MusicPlayer.toggleLoop();</span>
<span class="nc" id="L106">    		loopButton.pseudoClassStateChanged(active, MusicPlayer.isLoopActive());</span>
<span class="nc" id="L107">    	});</span>
<span class="nc" id="L108">    	shuffleButton.setOnMouseClicked(x -&gt; {</span>
<span class="nc" id="L109">    		sideBar.requestFocus();</span>
<span class="nc" id="L110">    		MusicPlayer.toggleShuffle();</span>
<span class="nc" id="L111">    		shuffleButton.pseudoClassStateChanged(active, MusicPlayer.isShuffleActive());</span>
<span class="nc" id="L112">    	});</span>
    	
<span class="nc" id="L114">    	timeSlider.setFocusTraversable(false);</span>
    	
<span class="nc" id="L116">        timeSlider.valueChangingProperty().addListener(</span>
            (slider, wasChanging, isChanging) -&gt; {

<span class="nc bnc" id="L119" title="All 2 branches missed.">                if (wasChanging) {</span>

<span class="nc" id="L121">                    int seconds = (int) Math.round(timeSlider.getValue() / 4.0);</span>
<span class="nc" id="L122">                    timeSlider.setValue(seconds * 4);</span>
<span class="nc" id="L123">                    MusicPlayer.seek(seconds);</span>
                }
<span class="nc" id="L125">            }</span>
        );

<span class="nc" id="L128">        timeSlider.valueProperty().addListener(</span>
            (slider, oldValue, newValue) -&gt; {

<span class="nc" id="L131">                double previous = oldValue.doubleValue();</span>
<span class="nc" id="L132">                double current = newValue.doubleValue();</span>
<span class="nc bnc" id="L133" title="All 6 branches missed.">                if (!timeSlider.isValueChanging() &amp;&amp; current != previous + 1 &amp;&amp; !isTimeSliderPressed()) {</span>

<span class="nc" id="L135">                    int seconds = (int) Math.round(current / 4.0);</span>
<span class="nc" id="L136">                    timeSlider.setValue(seconds * 4);</span>
<span class="nc" id="L137">                    MusicPlayer.seek(seconds);</span>
                }
<span class="nc" id="L139">            }</span>
        );
        
<span class="nc" id="L142">        unloadLettersAnimation.setOnFinished(x -&gt; {</span>
<span class="nc" id="L143">        	letterBox.setPrefHeight(0);</span>
<span class="nc" id="L144">        	letterSeparator.setPrefHeight(0);</span>
<span class="nc" id="L145">		});</span>

<span class="nc" id="L147">		searchBox.textProperty().addListener((observable, oldText, newText) -&gt; {</span>
<span class="nc" id="L148">			String text = newText.trim();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">			if (text.equals(&quot;&quot;)) {</span>
<span class="nc bnc" id="L150" title="All 4 branches missed.">                if (searchPopup.isShowing() &amp;&amp; !searchHideAnimation.getStatus().equals(Status.RUNNING)) {</span>
<span class="nc" id="L151">                    searchHideAnimation.play();</span>
                }
            } else {
<span class="nc" id="L154">                Search.search(text);</span>
			}
<span class="nc" id="L156">		});</span>

<span class="nc" id="L158">		Search.hasResultsProperty().addListener((observable, hadResults, hasResults) -&gt; {</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">			if (hasResults) {</span>
<span class="nc" id="L160">                SearchResult result = Search.getResult();</span>
<span class="nc" id="L161">                Platform.runLater(() -&gt; {</span>
<span class="nc" id="L162">                    showSearchResults(result);</span>
<span class="nc" id="L163">                    MusicPlayer.getStage().toFront();</span>
<span class="nc" id="L164">                });</span>
<span class="nc" id="L165">                int height = 0;</span>
<span class="nc" id="L166">                int artists = result.getArtistResults().size();</span>
<span class="nc" id="L167">                int albums = result.getAlbumResults().size();</span>
<span class="nc" id="L168">                int songs = result.getSongResults().size();</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">                if (artists &gt; 0) height += (artists * 50) + 50;</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">                if (albums &gt; 0) height += (albums * 50) + 50;</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                if (songs &gt; 0) height += (songs * 50) + 50;</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                if (height == 0) height = 50;</span>
<span class="nc" id="L173">                searchPopup.setHeight(height);</span>
            }
<span class="nc" id="L175">		});</span>

<span class="nc" id="L177">		MusicPlayer.getStage().xProperty().addListener((observable, oldValue, newValue) -&gt; {</span>
<span class="nc bnc" id="L178" title="All 4 branches missed.">            if (searchPopup.isShowing() &amp;&amp; !searchHideAnimation.getStatus().equals(Status.RUNNING)) {</span>
<span class="nc" id="L179">                searchHideAnimation.play();</span>
            }
<span class="nc" id="L181">        });</span>

<span class="nc" id="L183">        MusicPlayer.getStage().yProperty().addListener((observable, oldValue, newValue) -&gt; {</span>
<span class="nc bnc" id="L184" title="All 4 branches missed.">            if (searchPopup.isShowing() &amp;&amp; !searchHideAnimation.getStatus().equals(Status.RUNNING)) {</span>
<span class="nc" id="L185">                searchHideAnimation.play();</span>
            }
<span class="nc" id="L187">        });</span>

<span class="nc bnc" id="L189" title="All 2 branches missed.">		for (Node node : letterBox.getChildren()) {</span>
<span class="nc" id="L190">        	Label label = (Label)node;</span>
<span class="nc" id="L191">        	label.prefWidthProperty().bind(letterBox.widthProperty().subtract(50).divide(26).subtract(1));</span>
<span class="nc" id="L192">        }</span>
        
<span class="nc" id="L194">        updateNowPlayingButton();</span>
<span class="nc" id="L195">        initializeTimeSlider();</span>
<span class="nc" id="L196">        initializeTimeLabels();</span>
<span class="nc" id="L197">        initializePlaylists();</span>
        
        // Register media keys on Windows
<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (System.getProperty(&quot;os.name&quot;).toUpperCase().contains(&quot;WINDOWS&quot;)) {</span>
<span class="nc" id="L201">        	JIntellitype.getInstance().addIntellitypeListener(this);</span>
        }
        
        // Loads the default view: artists.
<span class="nc" id="L205">        loadView(&quot;artists&quot;);</span>
<span class="nc" id="L206">    }</span>
    
    @Override
    public void onIntellitype(int key) {
    	// Skip/play/pause/back using Windows media keys
<span class="nc" id="L211">    	Platform.runLater(() -&gt; {</span>
<span class="nc bnc" id="L212" title="All 4 branches missed.">    		switch (key) {</span>
        	case JIntellitype.APPCOMMAND_MEDIA_NEXTTRACK:
<span class="nc" id="L214">        		skip();</span>
<span class="nc" id="L215">        		break;</span>
        	case JIntellitype.APPCOMMAND_MEDIA_PLAY_PAUSE:
<span class="nc" id="L217">        		playPause();</span>
<span class="nc" id="L218">        		break;</span>
        	case JIntellitype.APPCOMMAND_MEDIA_PREVIOUSTRACK:
<span class="nc" id="L220">        		back();</span>
        		break;
        	}
<span class="nc" id="L223">    	});</span>
<span class="nc" id="L224">    }</span>
    
    void resetLatch() {
<span class="nc" id="L227">    	viewLoadedLatch = new CountDownLatch(1);</span>
<span class="nc" id="L228">    }</span>
    
    CountDownLatch getLatch() {
<span class="nc" id="L231">    	return viewLoadedLatch;</span>
    }
    
    private void createVolumePopup() {
    	try {
    		
<span class="nc" id="L237">    		Stage stage = MusicPlayer.getStage();</span>
<span class="nc" id="L238">        	FXMLLoader loader = new FXMLLoader(this.getClass().getResource(Resources.FXML + &quot;VolumePopup.fxml&quot;));</span>
<span class="nc" id="L239">        	HBox view = loader.load();</span>
<span class="nc" id="L240">        	volumePopupController = loader.getController();</span>
<span class="nc" id="L241">        	Stage popup = new Stage();</span>
<span class="nc" id="L242">        	popup.setScene(new Scene(view));</span>
<span class="nc" id="L243">        	popup.initStyle(StageStyle.UNDECORATED);</span>
<span class="nc" id="L244">        	popup.initOwner(stage);</span>
<span class="nc" id="L245">        	popup.setX(stage.getWidth() - 270);</span>
<span class="nc" id="L246">        	popup.setY(stage.getHeight() - 120);</span>
<span class="nc" id="L247">        	popup.focusedProperty().addListener((x, wasFocused, isFocused) -&gt; {</span>
<span class="nc bnc" id="L248" title="All 4 branches missed.">        		if (wasFocused &amp;&amp; !isFocused) {</span>
<span class="nc" id="L249">        			volumeHideAnimation.play();</span>
        		}
<span class="nc" id="L251">        	});</span>
<span class="nc" id="L252">        	volumeHideAnimation.setOnFinished(x -&gt; popup.hide());</span>
        	
<span class="nc" id="L254">        	popup.show();</span>
<span class="nc" id="L255">        	popup.hide();</span>
<span class="nc" id="L256">        	volumePopup = popup;</span>
        	
<span class="nc" id="L258">    	} catch (Exception ex) {</span>
    		
<span class="nc" id="L260">    		ex.printStackTrace();</span>
<span class="nc" id="L261">    	}</span>
<span class="nc" id="L262">    }</span>

	private void createSearchPopup() {
		try {

<span class="nc" id="L267">			Stage stage = MusicPlayer.getStage();</span>
<span class="nc" id="L268">			VBox view = new VBox();</span>
<span class="nc" id="L269">            view.getStylesheets().add(Resources.CSS + &quot;MainStyle.css&quot;);</span>
<span class="nc" id="L270">            view.getStyleClass().add(&quot;searchPopup&quot;);</span>
<span class="nc" id="L271">			Stage popup = new Stage();</span>
<span class="nc" id="L272">			popup.setScene(new Scene(view));</span>
<span class="nc" id="L273">			popup.initStyle(StageStyle.UNDECORATED);</span>
<span class="nc" id="L274">			popup.initOwner(stage);</span>
<span class="nc" id="L275">			searchHideAnimation.setOnFinished(x -&gt; popup.hide());</span>

<span class="nc" id="L277">			popup.show();</span>
<span class="nc" id="L278">			popup.hide();</span>
<span class="nc" id="L279">			searchPopup = popup;</span>

<span class="nc" id="L281">		} catch (Exception ex) {</span>

<span class="nc" id="L283">			ex.printStackTrace();</span>
<span class="nc" id="L284">		}</span>
<span class="nc" id="L285">	}</span>
    
    public void updateNowPlayingButton() {

<span class="nc" id="L289">        Song song = MusicPlayer.getNowPlaying();</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (song != null) {</span>
<span class="nc" id="L291">            nowPlayingTitle.setText(song.getTitle());</span>
<span class="nc" id="L292">            nowPlayingArtist.setText(song.getArtist());</span>
<span class="nc" id="L293">            nowPlayingArtwork.setImage(song.getArtwork());</span>
        } else {
<span class="nc" id="L295">            nowPlayingTitle.setText(&quot;&quot;);</span>
<span class="nc" id="L296">            nowPlayingArtist.setText(&quot;&quot;);</span>
<span class="nc" id="L297">            nowPlayingArtwork.setImage(null);</span>
        }
<span class="nc" id="L299">    }</span>

    public void initializeTimeSlider() {

<span class="nc" id="L303">        Song song = MusicPlayer.getNowPlaying();</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">        if (song != null) {</span>
<span class="nc" id="L305">            timeSlider.setMin(0);</span>
<span class="nc" id="L306">            timeSlider.setMax(song.getLengthInSeconds() * 4);</span>
<span class="nc" id="L307">            timeSlider.setValue(0);</span>
<span class="nc" id="L308">            timeSlider.setBlockIncrement(1);</span>
        } else {
<span class="nc" id="L310">            timeSlider.setMin(0);</span>
<span class="nc" id="L311">            timeSlider.setMax(1);</span>
<span class="nc" id="L312">            timeSlider.setValue(0);</span>
<span class="nc" id="L313">            timeSlider.setBlockIncrement(1);</span>
        }
<span class="nc" id="L315">    }</span>

    public void updateTimeSlider() {

<span class="nc" id="L319">        timeSlider.increment();</span>
<span class="nc" id="L320">    }</span>

    public void initializeTimeLabels() {

<span class="nc" id="L324">        Song song = MusicPlayer.getNowPlaying();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">        if (song != null) {</span>
<span class="nc" id="L326">            timePassed.setText(&quot;0:00&quot;);</span>
<span class="nc" id="L327">            timeRemaining.setText(song.getLength());</span>
        } else {
<span class="nc" id="L329">            timePassed.setText(&quot;&quot;);</span>
<span class="nc" id="L330">            timeRemaining.setText(&quot;&quot;);</span>
        }
<span class="nc" id="L332">    }</span>

    public void updateTimeLabels() {

<span class="nc" id="L336">        timePassed.setText(MusicPlayer.getTimePassed());</span>
<span class="nc" id="L337">        timeRemaining.setText(MusicPlayer.getTimeRemaining());</span>
<span class="nc" id="L338">    }</span>
    
    @SuppressWarnings(&quot;unchecked&quot;)
	private void initializePlaylists() {
<span class="nc bnc" id="L342" title="All 2 branches missed.">    	for (Playlist playlist : Library.getPlaylists()) {</span>
    		try {
<span class="nc" id="L344">    			FXMLLoader loader = new FXMLLoader(this.getClass().getResource(Resources.FXML + &quot;PlaylistCell.fxml&quot;));</span>
<span class="nc" id="L345">				HBox cell = loader.load();</span>
<span class="nc" id="L346">				Label label = (Label) cell.getChildren().get(1);</span>
<span class="nc" id="L347">				label.setText(playlist.getTitle());</span>
				
<span class="nc" id="L349">				cell.setOnMouseClicked(x -&gt; {</span>
<span class="nc" id="L350">					selectView(x);</span>
<span class="nc" id="L351">					((PlaylistsController) subViewController).selectPlaylist(playlist);</span>
<span class="nc" id="L352">				});</span>
				
<span class="nc" id="L354">				cell.setOnDragDetected(event -&gt; {</span>
<span class="nc" id="L355">					PseudoClass pressed = PseudoClass.getPseudoClass(&quot;pressed&quot;);</span>
<span class="nc" id="L356">					cell.pseudoClassStateChanged(pressed, false);</span>
<span class="nc" id="L357">    	        	Dragboard db = cell.startDragAndDrop(TransferMode.ANY);</span>
<span class="nc" id="L358">    	        	ClipboardContent content = new ClipboardContent();</span>
<span class="nc" id="L359">    	            content.putString(&quot;Playlist&quot;);</span>
<span class="nc" id="L360">    	            db.setContent(content);</span>
<span class="nc" id="L361">    	        	MusicPlayer.setDraggedItem(playlist);</span>
<span class="nc" id="L362">    	        	db.setDragView(cell.snapshot(null, null), 125, 25);</span>
<span class="nc" id="L363">    	            event.consume();</span>
<span class="nc" id="L364">    	        });</span>
				
<span class="nc" id="L366">				PseudoClass hover = PseudoClass.getPseudoClass(&quot;hover&quot;);</span>
				
<span class="nc" id="L368">				cell.setOnDragEntered(event -&gt; {</span>
<span class="nc bnc" id="L369" title="All 4 branches missed.">					if (!(playlist instanceof MostPlayedPlaylist)</span>
							&amp;&amp; !(playlist instanceof RecentlyPlayedPlaylist)
<span class="nc bnc" id="L371" title="All 2 branches missed.">							&amp;&amp; event.getGestureSource() != cell</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">							&amp;&amp; event.getDragboard().hasString()) {</span>
						
<span class="nc" id="L374">						cell.pseudoClassStateChanged(hover, true);</span>
						//cell.getStyleClass().setAll(&quot;sideBarItemSelected&quot;);
					}
<span class="nc" id="L377">				});</span>
				
<span class="nc" id="L379">				cell.setOnDragExited(event -&gt; {</span>
<span class="nc bnc" id="L380" title="All 4 branches missed.">					if (!(playlist instanceof MostPlayedPlaylist)</span>
							&amp;&amp; !(playlist instanceof RecentlyPlayedPlaylist)
<span class="nc bnc" id="L382" title="All 2 branches missed.">							&amp;&amp; event.getGestureSource() != cell</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">							&amp;&amp; event.getDragboard().hasString()) {</span>
						
<span class="nc" id="L385">						cell.pseudoClassStateChanged(hover, false);</span>
						//cell.getStyleClass().setAll(&quot;sideBarItem&quot;);
					}
<span class="nc" id="L388">				});</span>
				
<span class="nc" id="L390">				cell.setOnDragOver(event -&gt; {</span>
<span class="nc bnc" id="L391" title="All 4 branches missed.">					if (!(playlist instanceof MostPlayedPlaylist)</span>
							&amp;&amp; !(playlist instanceof RecentlyPlayedPlaylist)
<span class="nc bnc" id="L393" title="All 2 branches missed.">							&amp;&amp; event.getGestureSource() != cell</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">							&amp;&amp; event.getDragboard().hasString()) {</span>
						
<span class="nc" id="L396">						event.acceptTransferModes(TransferMode.ANY);</span>
					}
<span class="nc" id="L398">					event.consume();</span>
<span class="nc" id="L399">				});</span>
				
<span class="nc" id="L401">				cell.setOnDragDropped(event -&gt; {</span>
<span class="nc" id="L402">					String dragString = event.getDragboard().getString();</span>
<span class="nc" id="L403">					new Thread(() -&gt; {</span>
<span class="nc bnc" id="L404" title="All 6 branches missed.">						switch (dragString) {</span>
			            case &quot;Artist&quot;:
<span class="nc" id="L406">			            	Artist artist = (Artist) MusicPlayer.getDraggedItem();</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">				            for (Album album : artist.getAlbums()) {</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">				            	for (Song song : album.getSongs()) {</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">				            		if (!playlist.getSongs().contains(song)) {</span>
<span class="nc" id="L410">						            	playlist.addSong(song);</span>
				            		}
<span class="nc" id="L412">					            }</span>
<span class="nc" id="L413">				            }</span>
<span class="nc" id="L414">				            break;</span>
			            case &quot;Album&quot;:
<span class="nc" id="L416">			            	Album album = (Album) MusicPlayer.getDraggedItem();</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">				            for (Song song : album.getSongs()) {</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">				            	if (!playlist.getSongs().contains(song)) {</span>
<span class="nc" id="L419">					            	playlist.addSong(song);</span>
			            		}
<span class="nc" id="L421">				            }</span>
<span class="nc" id="L422">				            break;</span>
			            case &quot;Playlist&quot;:
<span class="nc" id="L424">			            	Playlist list = (Playlist) MusicPlayer.getDraggedItem();</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">				            for (Song song : list.getSongs()) {</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">				            	if (!playlist.getSongs().contains(song)) {</span>
<span class="nc" id="L427">					            	playlist.addSong(song);</span>
			            		}
<span class="nc" id="L429">				            }</span>
<span class="nc" id="L430">				            break;</span>
			            case &quot;Song&quot;:
<span class="nc" id="L432">			            	Song song = (Song) MusicPlayer.getDraggedItem();</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">			            	if (!playlist.getSongs().contains(song)) {</span>
<span class="nc" id="L434">				            	playlist.addSong(song);</span>
		            		}
				            break;
			            case &quot;List&quot;:
<span class="nc" id="L438">							ObservableList&lt;Song&gt; songs = (ObservableList&lt;Song&gt;) MusicPlayer.getDraggedItem();</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">			            	for (Song s : songs) {</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">			            		if (!playlist.getSongs().contains(s)) {</span>
<span class="nc" id="L441">					            	playlist.addSong(s);</span>
			            		}
<span class="nc" id="L443">			            	}</span>
			            	break;
			            }
<span class="nc" id="L446">					}).start();</span>
					
<span class="nc" id="L448">					event.consume();</span>
<span class="nc" id="L449">				});</span>
				
<span class="nc" id="L451">				playlistBox.getChildren().add(cell);</span>
				
<span class="nc" id="L453">			} catch (Exception e) {</span>
				
<span class="nc" id="L455">				e.printStackTrace();</span>
<span class="nc" id="L456">			}</span>
<span class="nc" id="L457">    	}</span>
<span class="nc" id="L458">    }</span>
    
    @FXML
    private void selectView(Event e) {

<span class="nc" id="L463">        HBox eventSource = ((HBox)e.getSource());</span>

<span class="nc" id="L465">        eventSource.requestFocus();</span>

<span class="nc" id="L467">        Optional&lt;Node&gt; previous = sideBar.getChildren().stream()</span>
<span class="nc" id="L468">            .filter(x -&gt; x.getStyleClass().get(0).equals(&quot;sideBarItemSelected&quot;)).findFirst();</span>

<span class="nc bnc" id="L470" title="All 2 branches missed.">        if (previous.isPresent()) {</span>
<span class="nc" id="L471">            HBox previousItem = (HBox) previous.get();</span>
<span class="nc" id="L472">            previousItem.getStyleClass().setAll(&quot;sideBarItem&quot;);</span>
<span class="nc" id="L473">        } else {</span>
<span class="nc" id="L474">        	previous = playlistBox.getChildren().stream()</span>
<span class="nc" id="L475">                    .filter(x -&gt; x.getStyleClass().get(0).equals(&quot;sideBarItemSelected&quot;)).findFirst();</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">        	if (previous.isPresent()) {</span>
<span class="nc" id="L477">                HBox previousItem = (HBox) previous.get();</span>
<span class="nc" id="L478">                previousItem.getStyleClass().setAll(&quot;sideBarItem&quot;);</span>
            }
        }

<span class="nc" id="L482">        ObservableList&lt;String&gt; styles = eventSource.getStyleClass();</span>

<span class="nc bnc" id="L484" title="All 2 branches missed.">        if (styles.get(0).equals(&quot;sideBarItem&quot;)) {</span>
<span class="nc" id="L485">            styles.setAll(&quot;sideBarItemSelected&quot;);</span>
<span class="nc" id="L486">            loadView(eventSource.getId());</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">        } else if (styles.get(0).equals(&quot;bottomBarItem&quot;)) {</span>
<span class="nc" id="L488">            loadView(eventSource.getId());</span>
        }
<span class="nc" id="L490">    }</span>
    
    @SuppressWarnings(&quot;unchecked&quot;)
	@FXML
    private void newPlaylist() {
    	
<span class="nc bnc" id="L496" title="All 2 branches missed.">    	if (!newPlaylistAnimation.getStatus().equals(Status.RUNNING)) {</span>
    		
    		try {
        		
<span class="nc" id="L500">    			FXMLLoader loader = new FXMLLoader(this.getClass().getResource(Resources.FXML + &quot;PlaylistCell.fxml&quot;));</span>
<span class="nc" id="L501">    			HBox cell = loader.load();</span>
    			
<span class="nc" id="L503">    			Label label = (Label) cell.getChildren().get(1);</span>
<span class="nc" id="L504">    			label.setVisible(false);</span>
<span class="nc" id="L505">    			HBox.setMargin(label, new Insets(0, 0, 0, 0));</span>
    			
<span class="nc" id="L507">    			TextField textBox = new TextField();</span>
<span class="nc" id="L508">    			textBox.setPrefHeight(30);</span>
<span class="nc" id="L509">    			cell.getChildren().add(textBox);</span>
<span class="nc" id="L510">    			HBox.setMargin(textBox, new Insets(10, 10, 10, 9));</span>
    			
<span class="nc" id="L512">    			textBox.focusedProperty().addListener((obs, oldValue, newValue) -&gt; {</span>
<span class="nc bnc" id="L513" title="All 4 branches missed.">    				if (oldValue &amp;&amp; !newValue) {</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">    					String text = textBox.getText().equals(&quot;&quot;) ? &quot;New Playlist&quot; : textBox.getText();</span>
<span class="nc" id="L515">    					text = checkDuplicatePlaylist(text, 0);</span>
<span class="nc" id="L516">    					label.setText(text);</span>
<span class="nc" id="L517">        				cell.getChildren().remove(textBox);</span>
<span class="nc" id="L518">        				HBox.setMargin(label, new Insets(10, 10, 10, 10));</span>
<span class="nc" id="L519">        				label.setVisible(true);</span>
<span class="nc" id="L520">        				Library.addPlaylist(text);</span>
    				}
<span class="nc" id="L522">    			});</span>
    			
<span class="nc" id="L524">    			textBox.setOnKeyPressed(x -&gt; {</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">    				if (x.getCode() == KeyCode.ENTER)  {</span>
<span class="nc" id="L526">    		            sideBar.requestFocus();</span>
    		        }
<span class="nc" id="L528">    			});</span>
    			
<span class="nc" id="L530">    			cell.setOnMouseClicked(x -&gt; {</span>
<span class="nc" id="L531">    				selectView(x);</span>
<span class="nc" id="L532">    				Playlist playlist = Library.getPlaylist(label.getText());</span>
<span class="nc" id="L533">    				((PlaylistsController) subViewController).selectPlaylist(playlist);</span>
<span class="nc" id="L534">    			});</span>
    			
<span class="nc" id="L536">    			cell.setOnDragDetected(event -&gt; {</span>
<span class="nc" id="L537">    				PseudoClass pressed = PseudoClass.getPseudoClass(&quot;pressed&quot;);</span>
<span class="nc" id="L538">					cell.pseudoClassStateChanged(pressed, false);</span>
<span class="nc" id="L539">    				Playlist playlist = Library.getPlaylist(label.getText());</span>
<span class="nc" id="L540">    	        	Dragboard db = cell.startDragAndDrop(TransferMode.ANY);</span>
<span class="nc" id="L541">    	        	ClipboardContent content = new ClipboardContent();</span>
<span class="nc" id="L542">    	            content.putString(&quot;Playlist&quot;);</span>
<span class="nc" id="L543">    	            db.setContent(content);</span>
<span class="nc" id="L544">    	        	MusicPlayer.setDraggedItem(playlist);</span>
<span class="nc" id="L545">    	        	SnapshotParameters sp = new SnapshotParameters();</span>
<span class="nc" id="L546">    	        	sp.setTransform(Transform.scale(1.5, 1.5));</span>
<span class="nc" id="L547">    	        	db.setDragView(cell.snapshot(sp, null));</span>
<span class="nc" id="L548">    	            event.consume();</span>
<span class="nc" id="L549">    	        });</span>
    			
<span class="nc" id="L551">    			PseudoClass hover = PseudoClass.getPseudoClass(&quot;hover&quot;);</span>
				
<span class="nc" id="L553">    			cell.setOnDragEntered(event -&gt; {</span>
<span class="nc" id="L554">    				Playlist playlist = Library.getPlaylist(label.getText());</span>
<span class="nc bnc" id="L555" title="All 4 branches missed.">					if (!(playlist instanceof MostPlayedPlaylist)</span>
							&amp;&amp; !(playlist instanceof RecentlyPlayedPlaylist)
<span class="nc bnc" id="L557" title="All 2 branches missed.">							&amp;&amp; event.getGestureSource() != cell</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">							&amp;&amp; event.getDragboard().hasString()) {</span>
						
<span class="nc" id="L560">						cell.pseudoClassStateChanged(hover, true);</span>
					}
<span class="nc" id="L562">				});</span>
				
<span class="nc" id="L564">				cell.setOnDragExited(event -&gt; {</span>
<span class="nc" id="L565">					Playlist playlist = Library.getPlaylist(label.getText());</span>
<span class="nc bnc" id="L566" title="All 4 branches missed.">					if (!(playlist instanceof MostPlayedPlaylist)</span>
							&amp;&amp; !(playlist instanceof RecentlyPlayedPlaylist)
<span class="nc bnc" id="L568" title="All 2 branches missed.">							&amp;&amp; event.getGestureSource() != cell</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">							&amp;&amp; event.getDragboard().hasString()) {</span>
						
<span class="nc" id="L571">						cell.pseudoClassStateChanged(hover, false);</span>
					}
<span class="nc" id="L573">				});</span>
				
<span class="nc" id="L575">				cell.setOnDragOver(event -&gt; {</span>
<span class="nc" id="L576">					Playlist playlist = Library.getPlaylist(label.getText());</span>
<span class="nc bnc" id="L577" title="All 4 branches missed.">					if (!(playlist instanceof MostPlayedPlaylist)</span>
							&amp;&amp; !(playlist instanceof RecentlyPlayedPlaylist)
<span class="nc bnc" id="L579" title="All 2 branches missed.">							&amp;&amp; event.getGestureSource() != cell</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">							&amp;&amp; event.getDragboard().hasString()) {</span>
						
<span class="nc" id="L582">						event.acceptTransferModes(TransferMode.ANY);</span>
					}
<span class="nc" id="L584">					event.consume();</span>
<span class="nc" id="L585">				});</span>
				
<span class="nc" id="L587">				cell.setOnDragDropped(event -&gt; {</span>
<span class="nc" id="L588">					Playlist playlist = Library.getPlaylist(label.getText());</span>
<span class="nc" id="L589">					String dragString = event.getDragboard().getString();</span>
<span class="nc" id="L590">					new Thread(() -&gt; {</span>
<span class="nc bnc" id="L591" title="All 6 branches missed.">						switch (dragString) {</span>
			            case &quot;Artist&quot;:
<span class="nc" id="L593">			            	Artist artist = (Artist) MusicPlayer.getDraggedItem();</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">				            for (Album album : artist.getAlbums()) {</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">				            	for (Song song : album.getSongs()) {</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">				            		if (!playlist.getSongs().contains(song)) {</span>
<span class="nc" id="L597">						            	playlist.addSong(song);</span>
				            		}
<span class="nc" id="L599">					            }</span>
<span class="nc" id="L600">				            }</span>
<span class="nc" id="L601">				            break;</span>
			            case &quot;Album&quot;:
<span class="nc" id="L603">			            	Album album = (Album) MusicPlayer.getDraggedItem();</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">				            for (Song song : album.getSongs()) {</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">				            	if (!playlist.getSongs().contains(song)) {</span>
<span class="nc" id="L606">					            	playlist.addSong(song);</span>
			            		}
<span class="nc" id="L608">				            }</span>
<span class="nc" id="L609">				            break;</span>
			            case &quot;Playlist&quot;:
<span class="nc" id="L611">			            	Playlist list = (Playlist) MusicPlayer.getDraggedItem();</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">				            for (Song song : list.getSongs()) {</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">				            	if (!playlist.getSongs().contains(song)) {</span>
<span class="nc" id="L614">					            	playlist.addSong(song);</span>
			            		}
<span class="nc" id="L616">				            }</span>
<span class="nc" id="L617">				            break;</span>
			            case &quot;Song&quot;:
<span class="nc" id="L619">			            	Song song = (Song) MusicPlayer.getDraggedItem();</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">			            	if (!playlist.getSongs().contains(song)) {</span>
<span class="nc" id="L621">				            	playlist.addSong(song);</span>
		            		}
				            break;
			            case &quot;List&quot;:
<span class="nc" id="L625">							ObservableList&lt;Song&gt; songs = (ObservableList&lt;Song&gt;) MusicPlayer.getDraggedItem();</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">			            	for (Song s : songs) {</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">			            		if (!playlist.getSongs().contains(s)) {</span>
<span class="nc" id="L628">					            	playlist.addSong(s);</span>
			            		}
<span class="nc" id="L630">			            	}</span>
			            	break;
			            }
<span class="nc" id="L633">					}).start();</span>
					
<span class="nc" id="L635">					event.consume();</span>
<span class="nc" id="L636">				});</span>
    			
<span class="nc" id="L638">    			cell.setPrefHeight(0);</span>
<span class="nc" id="L639">    			cell.setOpacity(0);</span>
    			
<span class="nc" id="L641">    			playlistBox.getChildren().add(1, cell);</span>
    			
<span class="nc" id="L643">    			textBox.requestFocus();</span>
    			
<span class="nc" id="L645">    		} catch (Exception e) {</span>
    			
<span class="nc" id="L647">    			e.printStackTrace();</span>
<span class="nc" id="L648">    		}</span>
        	
<span class="nc" id="L650">        	newPlaylistAnimation.play();</span>
    	}
<span class="nc" id="L652">    }</span>
    
    private String checkDuplicatePlaylist(String text, int i) {
<span class="nc bnc" id="L655" title="All 2 branches missed.">    	for (Playlist playlist : Library.getPlaylists()) {</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">    		if (playlist.getTitle().equals(text)) {</span>
    			
<span class="nc" id="L658">    			int index = text.lastIndexOf(' ') + 1;</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">    			if (index != 0) {</span>
    				try {
<span class="nc" id="L661">    					i = Integer.parseInt(text.substring(index));</span>
<span class="nc" id="L662">    				} catch (Exception ex) {</span>
    					// do nothing
<span class="nc" id="L664">    				}</span>
    			}
    			
<span class="nc" id="L667">    			i++;</span>
    			
<span class="nc bnc" id="L669" title="All 2 branches missed.">    			if (i == 1) {</span>
<span class="nc" id="L670">    				text = checkDuplicatePlaylist(text + &quot; &quot; + i, i);</span>
    			} else {
<span class="nc" id="L672">    				text = checkDuplicatePlaylist(text.substring(0, index) + i, i);</span>
    			}
<span class="nc" id="L674">    			break;</span>
    		}
<span class="nc" id="L676">    	}</span>
    	
<span class="nc" id="L678">    	return text;</span>
    }
    
    public SubView loadView(String viewName) {
        try {
        	
        	boolean loadLetters;
        	boolean unloadLetters;
        	
<span class="nc bnc" id="L687" title="All 2 branches missed.">        	switch (viewName.toLowerCase()) {</span>
        	case &quot;artists&quot;:
        	case &quot;artistsmain&quot;:
        	case &quot;albums&quot;:
        	case &quot;songs&quot;:
<span class="nc bnc" id="L692" title="All 8 branches missed.">        		if (subViewController instanceof ArtistsController</span>
        			|| subViewController instanceof ArtistsMainController
        			|| subViewController instanceof AlbumsController
        			|| subViewController instanceof SongsController) {
<span class="nc" id="L696">        			loadLetters = false;</span>
<span class="nc" id="L697">        			unloadLetters = false;</span>
        		} else {
<span class="nc" id="L699">        			loadLetters = true;</span>
<span class="nc" id="L700">        			unloadLetters = false;</span>
        		}
<span class="nc" id="L702">        		break;</span>
        	default:
<span class="nc bnc" id="L704" title="All 8 branches missed.">        		if (subViewController instanceof ArtistsController</span>
        			|| subViewController instanceof ArtistsMainController
        			|| subViewController instanceof AlbumsController
        			|| subViewController instanceof SongsController) {
<span class="nc" id="L708">        			loadLetters = false;</span>
<span class="nc" id="L709">        			unloadLetters = true;</span>
        		} else {
<span class="nc" id="L711">        			loadLetters = false;</span>
<span class="nc" id="L712">        			unloadLetters = false;</span>
        		}
        		break;
        	}
	        
<span class="nc" id="L717">	        final boolean loadLettersFinal = loadLetters;</span>
<span class="nc" id="L718">	        final boolean unloadLettersFinal = unloadLetters;</span>
        	
<span class="nc" id="L720">            String fileName = viewName.substring(0, 1).toUpperCase() + viewName.substring(1) + &quot;.fxml&quot;;</span>
            
<span class="nc" id="L722">            FXMLLoader loader = new FXMLLoader(this.getClass().getResource(fileName));</span>
<span class="nc" id="L723">            Node view = loader.load();</span>
            
<span class="nc" id="L725">            CountDownLatch latch = new CountDownLatch(1);</span>
            
<span class="nc" id="L727">            Task&lt;Void&gt; task = new Task&lt;Void&gt;() {</span>
	        	@Override protected Void call() throws Exception {
<span class="nc" id="L729">	        		Platform.runLater(() -&gt; {</span>
<span class="nc" id="L730">	        			Library.getSongs().stream().filter(x -&gt; x.getSelected()).forEach(x -&gt; x.setSelected(false));</span>
<span class="nc" id="L731">	        			subViewRoot.setVisible(false);</span>
<span class="nc" id="L732">			        	subViewRoot.setContent(view);</span>
<span class="nc" id="L733">			        	subViewRoot.getContent().setOpacity(0);</span>
<span class="nc" id="L734">			        	latch.countDown();</span>
<span class="nc" id="L735">	        		});</span>
<span class="nc" id="L736">		        	return null;</span>
	        	}
	        };
	        
<span class="nc" id="L740">	        task.setOnSucceeded(x -&gt; new Thread(() -&gt; {</span>
                try {
<span class="nc" id="L742">                    latch.await();</span>
<span class="nc" id="L743">                } catch (Exception e) {</span>
<span class="nc" id="L744">                    e.printStackTrace();</span>
<span class="nc" id="L745">                }</span>
<span class="nc" id="L746">                Platform.runLater(() -&gt; {</span>
<span class="nc" id="L747">                    subViewRoot.setVisible(true);</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">                    if (loadLettersFinal) {</span>
<span class="nc" id="L749">                        loadLettersAnimation.play();</span>
                    }
<span class="nc" id="L751">                    loadViewAnimation.play();</span>
<span class="nc" id="L752">                });</span>
<span class="nc" id="L753">            }).start());</span>
	        
<span class="nc" id="L755">	        Thread thread = new Thread(task);</span>
            
<span class="nc" id="L757">            unloadViewAnimation.setOnFinished(x -&gt; thread.start());</span>
            
<span class="nc" id="L759">            loadViewAnimation.setOnFinished(x -&gt; viewLoadedLatch.countDown());</span>
            
<span class="nc bnc" id="L761" title="All 2 branches missed.">            if (subViewRoot.getContent() != null) {</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">            	if (unloadLettersFinal) {</span>
<span class="nc" id="L763">            		unloadLettersAnimation.play();</span>
            	}
<span class="nc" id="L765">	            unloadViewAnimation.play();</span>
        	} else {
<span class="nc" id="L767">        		subViewRoot.setContent(view);</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">        		if (loadLettersFinal) {</span>
<span class="nc" id="L769">        			loadLettersAnimation.play();</span>
        		}
<span class="nc" id="L771">        		loadViewAnimation.play();</span>
        	}
            
<span class="nc" id="L774">            subViewController = loader.getController();</span>
<span class="nc" id="L775">            return subViewController;</span>

<span class="nc" id="L777">        } catch (Exception ex) {</span>
<span class="nc" id="L778">            ex.printStackTrace();</span>
<span class="nc" id="L779">            return null;</span>
        }
    }
    
    @FXML
    private void navigateToCurrentSong() {
    	
<span class="nc" id="L786">    	Optional&lt;Node&gt; previous = sideBar.getChildren().stream()</span>
<span class="nc" id="L787">                .filter(x -&gt; x.getStyleClass().get(0).equals(&quot;sideBarItemSelected&quot;)).findFirst();</span>

<span class="nc bnc" id="L789" title="All 2 branches missed.">        if (previous.isPresent()) {</span>
<span class="nc" id="L790">            HBox previousItem = (HBox) previous.get();</span>
<span class="nc" id="L791">            previousItem.getStyleClass().setAll(&quot;sideBarItem&quot;);</span>
<span class="nc" id="L792">        } else {</span>
<span class="nc" id="L793">        	previous = playlistBox.getChildren().stream()</span>
<span class="nc" id="L794">                    .filter(x -&gt; x.getStyleClass().get(0).equals(&quot;sideBarItemSelected&quot;)).findFirst();</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">        	if (previous.isPresent()) {</span>
<span class="nc" id="L796">                HBox previousItem = (HBox) previous.get();</span>
<span class="nc" id="L797">                previousItem.getStyleClass().setAll(&quot;sideBarItem&quot;);</span>
            }
        }
        
<span class="nc" id="L801">        sideBar.getChildren().get(2).getStyleClass().setAll(&quot;sideBarItemSelected&quot;);</span>
        
<span class="nc" id="L803">        ArtistsMainController artistsMainController = (ArtistsMainController) loadView(&quot;ArtistsMain&quot;);</span>
<span class="nc" id="L804">        Song song = MusicPlayer.getNowPlaying();</span>
<span class="nc" id="L805">        Artist artist = Library.getArtist(song.getArtist());</span>
<span class="nc" id="L806">        Album album = artist.getAlbums().stream().filter(x -&gt; x.getTitle().equals(song.getAlbum())).findFirst().get();</span>
<span class="nc" id="L807">        artistsMainController.selectArtist(artist);</span>
<span class="nc" id="L808">        artistsMainController.selectAlbum(album);</span>
<span class="nc" id="L809">        artistsMainController.selectSong(song);</span>
<span class="nc" id="L810">    }</span>

    @FXML
    private void slideSideBar(Event e) {
<span class="nc" id="L814">    	sideBar.requestFocus();</span>
<span class="nc" id="L815">    	searchBox.setText(&quot;&quot;);</span>
<span class="nc bnc" id="L816" title="All 2 branches missed.">        if (isSideBarExpanded) {</span>
<span class="nc" id="L817">            collapseSideBar();</span>
        } else {
<span class="nc" id="L819">            expandSideBar();</span>
        }
<span class="nc" id="L821">    }</span>
    
    private void collapseSideBar() {
<span class="nc bnc" id="L824" title="All 2 branches missed.">        if (expandAnimation.statusProperty().get() == Animation.Status.STOPPED</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">            &amp;&amp; collapseAnimation.statusProperty().get() == Animation.Status.STOPPED) {</span>

<span class="nc" id="L827">            collapseAnimation.play();</span>
        }
<span class="nc" id="L829">    }</span>

    private void expandSideBar() {
<span class="nc bnc" id="L832" title="All 2 branches missed.">        if (expandAnimation.statusProperty().get() == Animation.Status.STOPPED</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">            &amp;&amp; collapseAnimation.statusProperty().get() == Animation.Status.STOPPED) {</span>

<span class="nc" id="L835">        	expandAnimation.play();</span>
        }
<span class="nc" id="L837">    }</span>

    @FXML
    public void playPause() {

<span class="nc" id="L842">    	sideBar.requestFocus();</span>
    	
<span class="nc bnc" id="L844" title="All 2 branches missed.">        if (MusicPlayer.isPlaying()) {</span>
<span class="nc" id="L845">            MusicPlayer.pause();</span>
        } else {
<span class="nc" id="L847">            MusicPlayer.play();</span>
        }
<span class="nc" id="L849">    }</span>

    @FXML
    private void back() {

<span class="nc" id="L854">    	sideBar.requestFocus();</span>
<span class="nc" id="L855">        MusicPlayer.back();</span>
<span class="nc" id="L856">    }</span>

    @FXML
    private void skip() {

<span class="nc" id="L861">    	sideBar.requestFocus();</span>
<span class="nc" id="L862">        MusicPlayer.skip();</span>
<span class="nc" id="L863">    }</span>
    
    @FXML
    private void letterClicked(Event e) {
    	
<span class="nc" id="L868">    	sideBar.requestFocus();</span>
<span class="nc" id="L869">    	Label eventSource = ((Label)e.getSource());</span>
<span class="nc" id="L870">    	char letter = eventSource.getText().charAt(0);</span>
<span class="nc" id="L871">    	subViewController.scroll(letter);</span>
<span class="nc" id="L872">    }</span>
    
    public void volumeClick() {
<span class="nc bnc" id="L875" title="All 2 branches missed.">    	if (!volumePopup.isShowing()) {</span>
<span class="nc" id="L876">    		Stage stage = MusicPlayer.getStage();</span>
<span class="nc" id="L877">    		volumePopup.setX(stage.getX() + stage.getWidth() - 265);</span>
<span class="nc" id="L878">        	volumePopup.setY(stage.getY() + stage.getHeight() - 115);</span>
<span class="nc" id="L879">    		volumePopup.show();</span>
<span class="nc" id="L880">    		volumeShowAnimation.play();</span>
    	}
<span class="nc" id="L882">    }</span>

    public void showSearchResults(SearchResult result) {
<span class="nc" id="L885">        VBox root = (VBox) searchPopup.getScene().getRoot();</span>
<span class="nc" id="L886">        ObservableList&lt;Node&gt; list = root.getChildren();</span>
<span class="nc" id="L887">        list.clear();</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">        if (result.getArtistResults().size() &gt; 0) {</span>
<span class="nc" id="L889">            Label header = new Label(&quot;Artists&quot;);</span>
<span class="nc" id="L890">            list.add(header);</span>
<span class="nc" id="L891">            VBox.setMargin(header, new Insets(10, 10, 10, 10));</span>
<span class="nc" id="L892">            result.getArtistResults().forEach(artist -&gt; {</span>
<span class="nc" id="L893">                HBox cell = new HBox();</span>
<span class="nc" id="L894">                cell.setAlignment(Pos.CENTER_LEFT);</span>
<span class="nc" id="L895">                cell.setPrefWidth(226);</span>
<span class="nc" id="L896">                cell.setPrefHeight(50);</span>
<span class="nc" id="L897">                ImageView image = new ImageView();</span>
<span class="nc" id="L898">                image.setFitHeight(40);</span>
<span class="nc" id="L899">                image.setFitWidth(40);</span>
<span class="nc" id="L900">                image.setImage(artist.getArtistImage());</span>
<span class="nc" id="L901">                Label label = new Label(artist.getTitle());</span>
<span class="nc" id="L902">                label.setTextOverrun(OverrunStyle.CLIP);</span>
<span class="nc" id="L903">                label.getStyleClass().setAll(&quot;searchLabel&quot;);</span>
<span class="nc" id="L904">                cell.getChildren().addAll(image, label);</span>
<span class="nc" id="L905">                HBox.setMargin(image, new Insets(5, 5, 5, 5));</span>
<span class="nc" id="L906">                HBox.setMargin(label, new Insets(10, 10, 10, 5));</span>
<span class="nc" id="L907">                cell.getStyleClass().add(&quot;searchResult&quot;);</span>
<span class="nc" id="L908">                cell.setOnMouseClicked(event -&gt; {</span>
<span class="nc" id="L909">                    loadView(&quot;ArtistsMain&quot;);</span>
<span class="nc" id="L910">                    ArtistsMainController artistsMainController = (ArtistsMainController) loadView(&quot;ArtistsMain&quot;);</span>
<span class="nc" id="L911">                    artistsMainController.selectArtist(artist);</span>
<span class="nc" id="L912">                    searchBox.setText(&quot;&quot;);</span>
<span class="nc" id="L913">                    sideBar.requestFocus();</span>
<span class="nc" id="L914">                });</span>
<span class="nc" id="L915">                list.add(cell);</span>
<span class="nc" id="L916">            });</span>
<span class="nc" id="L917">            Separator separator = new Separator();</span>
<span class="nc" id="L918">            separator.setPrefWidth(206);</span>
<span class="nc" id="L919">            list.add(separator);</span>
<span class="nc" id="L920">            VBox.setMargin(separator, new Insets(10, 10, 0, 10));</span>
        }
<span class="nc bnc" id="L922" title="All 2 branches missed.">        if (result.getAlbumResults().size() &gt; 0) {</span>
<span class="nc" id="L923">            Label header = new Label(&quot;Albums&quot;);</span>
<span class="nc" id="L924">            list.add(header);</span>
<span class="nc" id="L925">            VBox.setMargin(header, new Insets(10, 10, 10, 10));</span>
<span class="nc" id="L926">            result.getAlbumResults().forEach(album -&gt; {</span>
<span class="nc" id="L927">                HBox cell = new HBox();</span>
<span class="nc" id="L928">                cell.setAlignment(Pos.CENTER_LEFT);</span>
<span class="nc" id="L929">                cell.setPrefWidth(226);</span>
<span class="nc" id="L930">                cell.setPrefHeight(50);</span>
<span class="nc" id="L931">                ImageView image = new ImageView();</span>
<span class="nc" id="L932">                image.setFitHeight(40);</span>
<span class="nc" id="L933">                image.setFitWidth(40);</span>
<span class="nc" id="L934">                image.setImage(album.getArtwork());</span>
<span class="nc" id="L935">                Label label = new Label(album.getTitle());</span>
<span class="nc" id="L936">                label.setTextOverrun(OverrunStyle.CLIP);</span>
<span class="nc" id="L937">                label.getStyleClass().setAll(&quot;searchLabel&quot;);</span>
<span class="nc" id="L938">                cell.getChildren().addAll(image, label);</span>
<span class="nc" id="L939">                HBox.setMargin(image, new Insets(5, 5, 5, 5));</span>
<span class="nc" id="L940">                HBox.setMargin(label, new Insets(10, 10, 10, 5));</span>
<span class="nc" id="L941">                cell.getStyleClass().add(&quot;searchResult&quot;);</span>
<span class="nc" id="L942">                cell.setOnMouseClicked(event -&gt; {</span>
<span class="nc" id="L943">                    loadView(&quot;ArtistsMain&quot;);</span>
<span class="nc" id="L944">                    Artist artist = Library.getArtist(album.getArtist());</span>
<span class="nc" id="L945">                    ArtistsMainController artistsMainController = (ArtistsMainController) loadView(&quot;ArtistsMain&quot;);</span>
<span class="nc" id="L946">                    artistsMainController.selectArtist(artist);</span>
<span class="nc" id="L947">                    artistsMainController.selectAlbum(album);</span>
<span class="nc" id="L948">                    searchBox.setText(&quot;&quot;);</span>
<span class="nc" id="L949">                    sideBar.requestFocus();</span>
<span class="nc" id="L950">                });</span>
<span class="nc" id="L951">                list.add(cell);</span>
<span class="nc" id="L952">            });</span>
<span class="nc" id="L953">            Separator separator = new Separator();</span>
<span class="nc" id="L954">            separator.setPrefWidth(206);</span>
<span class="nc" id="L955">            list.add(separator);</span>
<span class="nc" id="L956">            VBox.setMargin(separator, new Insets(10, 10, 0, 10));</span>
        }
<span class="nc bnc" id="L958" title="All 2 branches missed.">        if (result.getSongResults().size() &gt; 0) {</span>
<span class="nc" id="L959">            Label header = new Label(&quot;Songs&quot;);</span>
<span class="nc" id="L960">            list.add(header);</span>
<span class="nc" id="L961">            VBox.setMargin(header, new Insets(10, 10, 10, 10));</span>
<span class="nc" id="L962">            result.getSongResults().forEach(song -&gt; {</span>
<span class="nc" id="L963">                HBox cell = new HBox();</span>
<span class="nc" id="L964">                cell.setAlignment(Pos.CENTER_LEFT);</span>
<span class="nc" id="L965">                cell.setPrefWidth(226);</span>
<span class="nc" id="L966">                cell.setPrefHeight(50);</span>
<span class="nc" id="L967">                Label label = new Label(song.getTitle());</span>
<span class="nc" id="L968">                label.setTextOverrun(OverrunStyle.CLIP);</span>
<span class="nc" id="L969">                label.getStyleClass().setAll(&quot;searchLabel&quot;);</span>
<span class="nc" id="L970">                cell.getChildren().add(label);</span>
<span class="nc" id="L971">                HBox.setMargin(label, new Insets(10, 10, 10, 10));</span>
<span class="nc" id="L972">                cell.getStyleClass().add(&quot;searchResult&quot;);</span>
<span class="nc" id="L973">                cell.setOnMouseClicked(event -&gt; {</span>
<span class="nc" id="L974">                    loadView(&quot;ArtistsMain&quot;);</span>
<span class="nc" id="L975">                    Artist artist = Library.getArtist(song.getArtist());</span>
<span class="nc" id="L976">                    Album album = artist.getAlbums().stream().filter(x -&gt; x.getTitle().equals(song.getAlbum())).findFirst().get();</span>
<span class="nc" id="L977">                    ArtistsMainController artistsMainController = (ArtistsMainController) loadView(&quot;ArtistsMain&quot;);</span>
<span class="nc" id="L978">                    artistsMainController.selectArtist(artist);</span>
<span class="nc" id="L979">                    artistsMainController.selectAlbum(album);</span>
<span class="nc" id="L980">                    artistsMainController.selectSong(song);</span>
<span class="nc" id="L981">                    searchBox.setText(&quot;&quot;);</span>
<span class="nc" id="L982">                    sideBar.requestFocus();</span>
<span class="nc" id="L983">                });</span>
<span class="nc" id="L984">                list.add(cell);</span>
<span class="nc" id="L985">            });</span>
        }
<span class="nc bnc" id="L987" title="All 2 branches missed.">        if (list.size() == 0) {</span>
<span class="nc" id="L988">            Label label = new Label(&quot;No Results&quot;);</span>
<span class="nc" id="L989">            list.add(label);</span>
<span class="nc" id="L990">            VBox.setMargin(label, new Insets(10, 10, 10, 10));</span>
        }
<span class="nc bnc" id="L992" title="All 2 branches missed.">        if (!searchPopup.isShowing()) {</span>
<span class="nc" id="L993">            Stage stage = MusicPlayer.getStage();</span>
<span class="nc" id="L994">            searchPopup.setX(stage.getX() + 18);</span>
<span class="nc" id="L995">            searchPopup.setY(stage.getY() + 80);</span>
<span class="nc" id="L996">            searchPopup.show();</span>
<span class="nc" id="L997">            searchShowAnimation.play();</span>
        }
<span class="nc" id="L999">    }</span>
    
    public Slider getVolumeSlider() {
<span class="nc" id="L1002">    	return volumePopupController.getSlider();</span>
    }
    
    public boolean isTimeSliderPressed() {
<span class="nc bnc" id="L1006" title="All 4 branches missed.">    	return sliderSkin.getThumb().isPressed() || sliderSkin.getTrack().isPressed();</span>
    }
    
    public SubView getSubViewController() {
    	
<span class="nc" id="L1011">    	return subViewController;</span>
    }
    
    ScrollPane getScrollPane() {
<span class="nc" id="L1015">    	return this.subViewRoot;</span>
    }

    VBox getPlaylistBox() {
<span class="nc" id="L1019">    	return playlistBox;</span>
    }

    public void updatePlayPauseIcon(boolean isPlaying) {

<span class="nc" id="L1024">    	controlBox.getChildren().remove(1);</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">    	if (isPlaying) {</span>
<span class="nc" id="L1026">           	controlBox.getChildren().add(1, pauseButton);</span>
        } else {
<span class="nc" id="L1028">          	controlBox.getChildren().add(1, playButton);</span>
        }
<span class="nc" id="L1030">    }</span>

    private void setSlideDirection() {
<span class="nc bnc" id="L1033" title="All 2 branches missed.">        isSideBarExpanded = !isSideBarExpanded;</span>
<span class="nc" id="L1034">    }</span>
    
<span class="nc" id="L1036">    private Animation volumeShowAnimation = new Transition() {</span>
    	{
<span class="nc" id="L1038">            setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L1039">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L1040">        }</span>
    	
        protected void interpolate(double frac) {
<span class="nc" id="L1043">        	volumePopup.setOpacity(frac);</span>
<span class="nc" id="L1044">        }</span>
    };
    
<span class="nc" id="L1047">    private Animation volumeHideAnimation = new Transition() {</span>
    	{
<span class="nc" id="L1049">            setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L1050">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L1051">        }</span>
        protected void interpolate(double frac) {
<span class="nc" id="L1053">            volumePopup.setOpacity(1.0 - frac);</span>
<span class="nc" id="L1054">        }</span>
    };

<span class="nc" id="L1057">    private Animation searchShowAnimation = new Transition() {</span>
        {
<span class="nc" id="L1059">            setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L1060">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L1061">        }</span>

        protected void interpolate(double frac) {
<span class="nc" id="L1064">            searchPopup.setOpacity(frac);</span>
<span class="nc" id="L1065">        }</span>
    };

<span class="nc" id="L1068">    private Animation searchHideAnimation = new Transition() {</span>
        {
<span class="nc" id="L1070">            setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L1071">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L1072">        }</span>
        protected void interpolate(double frac) {
<span class="nc" id="L1074">            searchPopup.setOpacity(1.0 - frac);</span>
<span class="nc" id="L1075">        }</span>
    };
    
<span class="nc" id="L1078">    private Animation collapseAnimation = new Transition() {</span>
        {
<span class="nc" id="L1080">            setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L1081">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L1082">            setOnFinished(x -&gt; setSlideDirection());</span>
<span class="nc" id="L1083">        }</span>
        protected void interpolate(double frac) {
<span class="nc" id="L1085">            double curWidth = collapsedWidth + (expandedWidth - collapsedWidth) * (1.0 - frac);</span>
<span class="nc" id="L1086">			double searchWidth = searchCollapsed + (searchExpanded - searchCollapsed) * (1.0 - frac);</span>
<span class="nc" id="L1087">            sideBar.setPrefWidth(curWidth);</span>
<span class="nc" id="L1088">			searchBox.setPrefWidth(searchWidth);</span>
<span class="nc" id="L1089">			searchBox.setOpacity(1.0 - frac);</span>
<span class="nc" id="L1090">        }</span>
    };

<span class="nc" id="L1093">    private Animation expandAnimation = new Transition() {</span>
        {
<span class="nc" id="L1095">            setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L1096">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L1097">            setOnFinished(x -&gt; setSlideDirection());</span>
<span class="nc" id="L1098">        }</span>
        protected void interpolate(double frac) {
<span class="nc" id="L1100">            double curWidth = collapsedWidth + (expandedWidth - collapsedWidth) * (frac);</span>
<span class="nc" id="L1101">			double searchWidth = searchCollapsed + (searchExpanded - searchCollapsed) * (frac);</span>
<span class="nc" id="L1102">			sideBar.setPrefWidth(curWidth);</span>
<span class="nc" id="L1103">			searchBox.setPrefWidth(searchWidth);</span>
<span class="nc" id="L1104">			searchBox.setOpacity(frac);</span>
<span class="nc" id="L1105">        }</span>
    };

<span class="nc" id="L1108">    private Animation loadViewAnimation = new Transition() {</span>
        {
<span class="nc" id="L1110">            setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L1111">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L1112">        }</span>
        protected void interpolate(double frac) {
<span class="nc" id="L1114">            subViewRoot.setVvalue(0);</span>
<span class="nc" id="L1115">            double curHeight = collapsedHeight + (expandedHeight - collapsedHeight) * (frac);</span>
<span class="nc" id="L1116">            subViewRoot.getContent().setTranslateY(expandedHeight - curHeight);</span>
<span class="nc" id="L1117">            subViewRoot.getContent().setOpacity(frac);</span>
<span class="nc" id="L1118">        }</span>
    };
    
<span class="nc" id="L1121">    private Animation unloadViewAnimation = new Transition() {</span>
        {
<span class="nc" id="L1123">            setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L1124">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L1125">        }</span>
        protected void interpolate(double frac) {
<span class="nc" id="L1127">            double curHeight = collapsedHeight + (expandedHeight - collapsedHeight) * (1 - frac);</span>
<span class="nc" id="L1128">            subViewRoot.getContent().setTranslateY(expandedHeight - curHeight);</span>
<span class="nc" id="L1129">            subViewRoot.getContent().setOpacity(1 - frac);</span>
<span class="nc" id="L1130">        }</span>
    };
    
<span class="nc" id="L1133">    private Animation loadLettersAnimation = new Transition() {</span>
    	{
<span class="nc" id="L1135">            setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L1136">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L1137">        }</span>
        protected void interpolate(double frac) {
<span class="nc" id="L1139">        	letterBox.setPrefHeight(50);</span>
<span class="nc" id="L1140">    		letterBox.setOpacity(frac);</span>
<span class="nc" id="L1141">    		letterSeparator.setPrefHeight(25);</span>
<span class="nc" id="L1142">    		letterSeparator.setOpacity(frac);</span>
<span class="nc" id="L1143">        }</span>
    };
    
<span class="nc" id="L1146">    private Animation unloadLettersAnimation = new Transition() {</span>
    	{
<span class="nc" id="L1148">            setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L1149">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L1150">        }</span>
        protected void interpolate(double frac) {
<span class="nc" id="L1152">    		letterBox.setOpacity(1.0 - frac);</span>
<span class="nc" id="L1153">    		letterSeparator.setOpacity(1.0 - frac);</span>
<span class="nc" id="L1154">        }</span>
    };
    
<span class="nc" id="L1157">    private Animation newPlaylistAnimation = new Transition() {</span>
    	{
<span class="nc" id="L1159">            setCycleDuration(Duration.millis(500));</span>
<span class="nc" id="L1160">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L1161">        }</span>
        protected void interpolate(double frac) {
<span class="nc" id="L1163">    		HBox cell = (HBox) playlistBox.getChildren().get(1);</span>
<span class="nc bnc" id="L1164" title="All 2 branches missed.">    		if (frac &lt; 0.5) {</span>
<span class="nc" id="L1165">    			cell.setPrefHeight(frac * 100);</span>
    		} else {
<span class="nc" id="L1167">    			cell.setPrefHeight(50);</span>
<span class="nc" id="L1168">    			cell.setOpacity((frac - 0.5) * 2);</span>
    		}
<span class="nc" id="L1170">        }</span>
    };
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>