<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArtistsMainController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MusicPlayerTest</a> &gt; <a href="index.source.html" class="el_package">app.musicplayer.view</a> &gt; <span class="el_source">ArtistsMainController.java</span></div><h1>ArtistsMainController.java</h1><pre class="source lang-java linenums">package app.musicplayer.view;

import java.net.URL;
import java.util.ArrayList;
import java.util.Collections;
import java.util.ResourceBundle;
import java.util.concurrent.CountDownLatch;

import app.musicplayer.MusicPlayer;
import app.musicplayer.model.Album;
import app.musicplayer.model.Artist;
import app.musicplayer.model.Library;
import app.musicplayer.model.Song;
import app.musicplayer.util.ClippedTableCell;
import app.musicplayer.util.ControlPanelTableCell;
import app.musicplayer.util.PlayingTableCell;
import app.musicplayer.util.SubView;
import javafx.animation.Animation;
import javafx.animation.Interpolator;
import javafx.animation.Transition;
import javafx.application.Platform;
import javafx.beans.value.ChangeListener;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.concurrent.Task;
import javafx.css.PseudoClass;
import javafx.fxml.FXML;
import javafx.fxml.Initializable;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.geometry.Rectangle2D;
import javafx.scene.control.Label;
import javafx.scene.control.ListCell;
import javafx.scene.control.ListView;
import javafx.scene.control.OverrunStyle;
import javafx.scene.control.ScrollPane;
import javafx.scene.control.SelectionMode;
import javafx.scene.control.Separator;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableRow;
import javafx.scene.control.TableView;
import javafx.scene.control.TableView.TableViewSelectionModel;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.image.ImageView;
import javafx.scene.input.ClipboardContent;
import javafx.scene.input.Dragboard;
import javafx.scene.input.KeyCode;
import javafx.scene.input.MouseEvent;
import javafx.scene.input.TransferMode;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.util.Duration;

<span class="nc" id="L54">public class ArtistsMainController implements Initializable, SubView {</span>

    private class ArtistCell extends ListCell&lt;Artist&gt; {

<span class="nc" id="L58">        private HBox cell = new HBox();</span>
<span class="nc" id="L59">        private ImageView artistImage = new ImageView();</span>
<span class="nc" id="L60">        private Label title = new Label();</span>
        private Artist artist;

<span class="nc" id="L63">        ArtistCell() {</span>
<span class="nc" id="L64">            super();</span>
<span class="nc" id="L65">            artistImage.setFitWidth(40);</span>
<span class="nc" id="L66">            artistImage.setFitHeight(40);</span>
<span class="nc" id="L67">            artistImage.setPreserveRatio(true);</span>
<span class="nc" id="L68">            artistImage.setSmooth(true);</span>
<span class="nc" id="L69">            artistImage.setCache(true);</span>
<span class="nc" id="L70">            title.setTextOverrun(OverrunStyle.CLIP);</span>
<span class="nc" id="L71">            cell.getChildren().addAll(artistImage, title);</span>
<span class="nc" id="L72">            cell.setAlignment(Pos.CENTER_LEFT);</span>
<span class="nc" id="L73">            HBox.setMargin(artistImage, new Insets(0, 10, 0, 0));</span>
<span class="nc" id="L74">            this.setPrefWidth(248);</span>
            
<span class="nc" id="L76">            this.setOnMouseClicked(event -&gt; artistList.getSelectionModel().select(artist));</span>
            
<span class="nc" id="L78">            this.setOnDragDetected(event -&gt; {</span>
<span class="nc" id="L79">            	Dragboard db = this.startDragAndDrop(TransferMode.ANY);</span>
<span class="nc" id="L80">            	ClipboardContent content = new ClipboardContent();</span>
<span class="nc" id="L81">                content.putString(&quot;Artist&quot;);</span>
<span class="nc" id="L82">                db.setContent(content);</span>
<span class="nc" id="L83">            	MusicPlayer.setDraggedItem(artist);</span>
<span class="nc" id="L84">            	db.setDragView(this.snapshot(null, null), 125, 25);</span>
<span class="nc" id="L85">            	event.consume();</span>
<span class="nc" id="L86">            });</span>
<span class="nc" id="L87">        }</span>

        @Override
        protected void updateItem(Artist artist, boolean empty) {

<span class="nc" id="L92">            super.updateItem(artist, empty);</span>
<span class="nc" id="L93">            this.artist = artist;</span>

<span class="nc bnc" id="L95" title="All 2 branches missed.">            if (empty){</span>

<span class="nc" id="L97">                setGraphic(null);</span>

            } else {

<span class="nc" id="L101">                title.setText(artist.getTitle());</span>
<span class="nc" id="L102">                artistImage.imageProperty().bind(artist.artistImageProperty());</span>
<span class="nc" id="L103">                setGraphic(cell);</span>
            }
<span class="nc" id="L105">        }</span>
    }

    private class AlbumCell extends ListCell&lt;Album&gt; {

<span class="nc" id="L110">        private ImageView albumArtwork = new ImageView();</span>
        private Album album;

<span class="nc" id="L113">        AlbumCell() {</span>
<span class="nc" id="L114">            super();</span>
<span class="nc" id="L115">            setAlignment(Pos.CENTER);</span>
<span class="nc" id="L116">            setPrefHeight(140);</span>
<span class="nc" id="L117">            setPrefWidth(140);</span>
<span class="nc" id="L118">            albumArtwork.setFitWidth(130);</span>
<span class="nc" id="L119">            albumArtwork.setFitHeight(130);</span>
<span class="nc" id="L120">            albumArtwork.setPreserveRatio(true);</span>
<span class="nc" id="L121">            albumArtwork.setSmooth(true);</span>
<span class="nc" id="L122">            albumArtwork.setCache(true);</span>
            
<span class="nc" id="L124">            this.setOnMouseClicked(event -&gt; albumList.getSelectionModel().select(album));</span>
            
<span class="nc" id="L126">            this.setOnDragDetected(event -&gt; {</span>
<span class="nc" id="L127">            	Dragboard db = this.startDragAndDrop(TransferMode.ANY);</span>
<span class="nc" id="L128">            	ClipboardContent content = new ClipboardContent();</span>
<span class="nc" id="L129">                content.putString(&quot;Album&quot;);</span>
<span class="nc" id="L130">                db.setContent(content);</span>
<span class="nc" id="L131">            	MusicPlayer.setDraggedItem(album);</span>
<span class="nc" id="L132">            	db.setDragView(this.snapshot(null, null), 75, 75);</span>
<span class="nc" id="L133">                event.consume();</span>
<span class="nc" id="L134">            });</span>
<span class="nc" id="L135">        }</span>

        @Override
        protected void updateItem(Album album, boolean empty) {

<span class="nc" id="L140">            super.updateItem(album, empty);</span>
<span class="nc" id="L141">            this.album = album;</span>

<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (empty){</span>

<span class="nc" id="L145">                setGraphic(null);</span>

            } else {

<span class="nc" id="L149">                albumArtwork.setImage(album.getArtwork());</span>
<span class="nc" id="L150">                setGraphic(albumArtwork);</span>
            }
<span class="nc" id="L152">        }</span>
    }

    @FXML private ListView&lt;Artist&gt; artistList;
    @FXML private ListView&lt;Album&gt; albumList;
    @FXML private TableView&lt;Song&gt; songTable;
    @FXML private TableColumn&lt;Song, Boolean&gt; playingColumn;
    @FXML private TableColumn&lt;Song, String&gt; titleColumn;
    @FXML private TableColumn&lt;Song, String&gt; lengthColumn;
    @FXML private TableColumn&lt;Song, Integer&gt; playsColumn;
    @FXML private Label artistLabel;
    @FXML private Label albumLabel;
    @FXML private Separator separator;
    @FXML private VBox subViewRoot;
    @FXML private ScrollPane scrollPane;
    @FXML private ScrollPane artistListScrollPane;

    private Song selectedSong;
    private Album selectedAlbum;
    private Artist selectedArtist;
<span class="nc" id="L172">    private double expandedHeight = 50;</span>
<span class="nc" id="L173">    private double collapsedHeight = 0;</span>
    private CountDownLatch loadedLatch;
    
    @Override
    public void initialize(URL location, ResourceBundle resources) {
    	
<span class="nc" id="L179">    	songTable.getSelectionModel().setSelectionMode(SelectionMode.MULTIPLE);</span>
    	
<span class="nc" id="L181">    	loadedLatch = new CountDownLatch(1);</span>
    	
<span class="nc" id="L183">    	artistLoadAnimation.setOnFinished(x -&gt; loadedLatch.countDown());</span>
    	
<span class="nc" id="L185">    	albumLoadAnimation.setOnFinished(x -&gt; loadedLatch.countDown());</span>
    	
<span class="nc" id="L187">    	titleColumn.prefWidthProperty().bind(songTable.widthProperty().subtract(50).multiply(0.5));</span>
<span class="nc" id="L188">        lengthColumn.prefWidthProperty().bind(songTable.widthProperty().subtract(50).multiply(0.25));</span>
<span class="nc" id="L189">        playsColumn.prefWidthProperty().bind(songTable.widthProperty().subtract(50).multiply(0.25));</span>

<span class="nc" id="L191">        playingColumn.setCellFactory(x -&gt; new PlayingTableCell&lt;&gt;());</span>
<span class="nc" id="L192">        titleColumn.setCellFactory(x -&gt; new ControlPanelTableCell&lt;&gt;());</span>
<span class="nc" id="L193">        lengthColumn.setCellFactory(x -&gt; new ClippedTableCell&lt;&gt;());</span>
<span class="nc" id="L194">        playsColumn.setCellFactory(x -&gt; new ClippedTableCell&lt;&gt;());</span>

<span class="nc" id="L196">        playingColumn.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;playing&quot;));</span>
<span class="nc" id="L197">        titleColumn.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;title&quot;));</span>
<span class="nc" id="L198">        lengthColumn.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;length&quot;));</span>
<span class="nc" id="L199">        playsColumn.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;playCount&quot;));</span>

<span class="nc" id="L201">        albumList.setCellFactory(listView -&gt; new AlbumCell());</span>
<span class="nc" id="L202">        artistList.setCellFactory(listView -&gt; new ArtistCell());</span>
        
<span class="nc" id="L204">        artistList.addEventFilter(MouseEvent.MOUSE_PRESSED, event -&gt; event.consume());</span>
        
<span class="nc" id="L206">        albumList.addEventFilter(MouseEvent.MOUSE_PRESSED, event -&gt; event.consume());</span>
        
<span class="nc" id="L208">        songTable.addEventFilter(MouseEvent.MOUSE_PRESSED, event -&gt; {</span>
<span class="nc" id="L209">        	songTable.requestFocus();</span>
<span class="nc" id="L210">        	event.consume();</span>
<span class="nc" id="L211">        });</span>

<span class="nc" id="L213">        ObservableList&lt;Artist&gt; artists = Library.getArtists();</span>
<span class="nc" id="L214">        Collections.sort(artists);</span>
        
<span class="nc" id="L216">        artistList.setItems(artists);</span>

<span class="nc" id="L218">        artistList.setOnMouseClicked(event -&gt; {</span>

<span class="nc bnc" id="L220" title="All 2 branches missed.">            if (event.getClickCount() == 2) {</span>

<span class="nc" id="L222">                ObservableList&lt;Song&gt; songs = FXCollections.observableArrayList();</span>
<span class="nc" id="L223">                ObservableList&lt;Album&gt; albums = FXCollections.observableArrayList();</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">                for (Album album : selectedArtist.getAlbums()) {</span>
<span class="nc" id="L225">                    albums.add(album);</span>
<span class="nc" id="L226">                    songs.addAll(album.getSongs());</span>
<span class="nc" id="L227">                }</span>
                
<span class="nc bnc" id="L229" title="All 2 branches missed.">                if (MusicPlayer.isShuffleActive()) {</span>
<span class="nc" id="L230">                	Collections.shuffle(songs);</span>
                } else {
<span class="nc" id="L232">                    Collections.sort(songs, (first, second) -&gt; {</span>

<span class="nc" id="L234">                        Album firstAlbum = albums.stream().filter(x -&gt; x.getTitle().equals(first.getAlbum())).findFirst().get();</span>
<span class="nc" id="L235">                        Album secondAlbum = albums.stream().filter(x -&gt; x.getTitle().equals(second.getAlbum())).findFirst().get();</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                        if (firstAlbum.compareTo(secondAlbum) != 0) {</span>
<span class="nc" id="L237">                            return firstAlbum.compareTo(secondAlbum);</span>
                        } else {
<span class="nc" id="L239">                            return first.compareTo(second);</span>
                        }
                    });
                }

<span class="nc" id="L244">                Song song = songs.get(0);</span>
<span class="nc" id="L245">                MusicPlayer.setNowPlayingList(songs);</span>
<span class="nc" id="L246">                MusicPlayer.setNowPlaying(song);</span>
<span class="nc" id="L247">                MusicPlayer.play();</span>

<span class="nc" id="L249">            } else {</span>
                	
<span class="nc" id="L251">            	Task&lt;Void&gt; task = new Task&lt;Void&gt;() {</span>
            		@Override protected Void call() throws Exception {
<span class="nc" id="L253">    	        		Platform.runLater(() -&gt; {</span>
<span class="nc" id="L254">    	        			subViewRoot.setVisible(false);</span>
<span class="nc" id="L255">    	        			selectedArtist = artistList.getSelectionModel().getSelectedItem();</span>
<span class="nc" id="L256">                            showAllSongs(selectedArtist, false);</span>
<span class="nc" id="L257">                            artistLabel.setText(selectedArtist.getTitle());</span>
<span class="nc" id="L258">                            albumList.setPrefWidth(albumList.getItems().size() * 150 + 2);</span>
<span class="nc" id="L259">                            albumList.setMaxWidth(albumList.getItems().size() * 150 + 2);</span>
<span class="nc" id="L260">                            albumList.scrollTo(0);</span>
<span class="nc" id="L261">    	        		});</span>
<span class="nc" id="L262">    		        	return null;</span>
    	        	}
            	};
            	
<span class="nc" id="L266">            	task.setOnSucceeded(x -&gt; Platform.runLater(() -&gt; {</span>
<span class="nc" id="L267">                    subViewRoot.setVisible(true);</span>
<span class="nc" id="L268">                    artistLoadAnimation.play();</span>
<span class="nc" id="L269">                }));</span>
            	
<span class="nc" id="L271">            	Thread thread = new Thread(task);</span>

<span class="nc" id="L273">            	artistUnloadAnimation.setOnFinished(x -&gt; thread.start());</span>
            	
<span class="nc" id="L275">            	artistUnloadAnimation.play();</span>
            }
<span class="nc" id="L277">        });</span>

<span class="nc" id="L279">        albumList.setOnMouseClicked(event -&gt; {</span>

<span class="nc" id="L281">            Album album = albumList.getSelectionModel().getSelectedItem();</span>

<span class="nc bnc" id="L283" title="All 2 branches missed.">            if (event.getClickCount() == 2) {</span>

<span class="nc bnc" id="L285" title="All 2 branches missed.">                if (album != selectedAlbum) {</span>
<span class="nc" id="L286">                    selectAlbum(album);</span>
                }

<span class="nc" id="L289">                ArrayList&lt;Song&gt; songs = selectedAlbum.getSongs();</span>

<span class="nc bnc" id="L291" title="All 2 branches missed.">                if (MusicPlayer.isShuffleActive()) {</span>
<span class="nc" id="L292">                	Collections.shuffle(songs);</span>
                } else {
<span class="nc" id="L294">                	Collections.sort(songs);</span>
                }

<span class="nc" id="L297">                MusicPlayer.setNowPlayingList(songs);</span>
<span class="nc" id="L298">                MusicPlayer.setNowPlaying(songs.get(0));</span>
<span class="nc" id="L299">                MusicPlayer.play();</span>

<span class="nc" id="L301">            } else {</span>
            	
<span class="nc" id="L303">            	Task&lt;Void&gt; task = new Task&lt;Void&gt;() {</span>
            		@Override protected Void call() throws Exception {
<span class="nc" id="L305">    	        		Platform.runLater(() -&gt; {</span>
<span class="nc" id="L306">    	        			songTable.setVisible(false);</span>
<span class="nc" id="L307">    	        			selectAlbum(album);</span>
<span class="nc" id="L308">    	        		});</span>
<span class="nc" id="L309">    		        	return null;</span>
    	        	}                		
            	};
            	
<span class="nc" id="L313">            	task.setOnSucceeded(x -&gt; Platform.runLater(() -&gt; {</span>
<span class="nc" id="L314">                    songTable.setVisible(true);</span>
<span class="nc" id="L315">                    albumLoadAnimation.play();</span>
<span class="nc" id="L316">                }));</span>
            	
<span class="nc" id="L318">            	Thread thread = new Thread(task);</span>

<span class="nc" id="L320">            	albumUnloadAnimation.setOnFinished(x -&gt; thread.start());</span>
            	
<span class="nc" id="L322">            	albumUnloadAnimation.play();</span>
            }
<span class="nc" id="L324">        });</span>

<span class="nc" id="L326">        songTable.setRowFactory(x -&gt; {</span>

<span class="nc" id="L328">            TableRow&lt;Song&gt; row = new TableRow&lt;&gt;();</span>

<span class="nc" id="L330">            PseudoClass playing = PseudoClass.getPseudoClass(&quot;playing&quot;);</span>

<span class="nc" id="L332">            ChangeListener&lt;Boolean&gt; changeListener = (obs, oldValue, newValue) -&gt; {</span>
<span class="nc" id="L333">                row.pseudoClassStateChanged(playing, newValue);</span>
<span class="nc" id="L334">            };</span>

<span class="nc" id="L336">            row.itemProperty().addListener((obs, previousSong, currentSong) -&gt; {</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">            	if (previousSong != null) {</span>
<span class="nc" id="L338">            		previousSong.playingProperty().removeListener(changeListener);</span>
            	}
<span class="nc bnc" id="L340" title="All 2 branches missed.">                if (currentSong != null) {</span>
<span class="nc" id="L341">                    currentSong.playingProperty().addListener(changeListener);</span>
<span class="nc" id="L342">                    row.pseudoClassStateChanged(playing, currentSong.getPlaying());</span>
                } else {
<span class="nc" id="L344">                    row.pseudoClassStateChanged(playing, false);</span>
                }
<span class="nc" id="L346">            });</span>

<span class="nc" id="L348">            row.setOnMouseClicked(event -&gt; {</span>
<span class="nc" id="L349">            	TableViewSelectionModel&lt;Song&gt; sm = songTable.getSelectionModel();</span>
<span class="nc bnc" id="L350" title="All 4 branches missed.">                if (event.getClickCount() == 2 &amp;&amp; !row.isEmpty()) {</span>
<span class="nc" id="L351">                    play();</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                } else if (event.isShiftDown()) {</span>
<span class="nc" id="L353">                	ArrayList&lt;Integer&gt; indices = new ArrayList&lt;&gt;(sm.getSelectedIndices());</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">                	if (indices.size() &lt; 1) {</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                		if (indices.contains(row.getIndex())) {</span>
<span class="nc" id="L356">                    		sm.clearSelection(row.getIndex());</span>
                    	} else {
<span class="nc" id="L358">                    		sm.select(row.getItem());</span>
                    	}
                	} else {
<span class="nc" id="L361">                		sm.clearSelection();</span>
<span class="nc" id="L362">	                	indices.sort((first, second) -&gt; first.compareTo(second));</span>
<span class="nc" id="L363">	                	int max = indices.get(indices.size() - 1);</span>
<span class="nc" id="L364">	                	int min = indices.get(0);</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">	                	if (min &lt; row.getIndex()) {</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">	                		for (int i = min; i &lt;= row.getIndex(); i++) {</span>
<span class="nc" id="L367">	                			sm.select(i);</span>
	                		}
	                	} else {
<span class="nc bnc" id="L370" title="All 2 branches missed.">	                		for (int i = row.getIndex(); i &lt;= max; i++) {</span>
<span class="nc" id="L371">	                			sm.select(i);</span>
	                		}
	                	}
                	}
                	
<span class="nc bnc" id="L376" title="All 2 branches missed.">                } else if (event.isControlDown()) {</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                	if (sm.getSelectedIndices().contains(row.getIndex())) {</span>
<span class="nc" id="L378">                		sm.clearSelection(row.getIndex());</span>
                	} else {
<span class="nc" id="L380">                		sm.select(row.getItem());</span>
                	}
                } else {
<span class="nc bnc" id="L383" title="All 2 branches missed.">                	if (sm.getSelectedIndices().size() &gt; 1) {</span>
<span class="nc" id="L384">                		sm.clearSelection();</span>
<span class="nc" id="L385">                    	sm.select(row.getItem());</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">                	} else if (sm.getSelectedIndices().contains(row.getIndex())) {</span>
<span class="nc" id="L387">                		sm.clearSelection();</span>
                	} else {
<span class="nc" id="L389">                		sm.clearSelection();</span>
<span class="nc" id="L390">                    	sm.select(row.getItem());</span>
                	}
                }
<span class="nc" id="L393">            });</span>
            
<span class="nc" id="L395">            row.setOnDragDetected(event -&gt; {</span>
<span class="nc" id="L396">            	Dragboard db = row.startDragAndDrop(TransferMode.ANY);</span>
<span class="nc" id="L397">            	ClipboardContent content = new ClipboardContent();</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">            	if (songTable.getSelectionModel().getSelectedIndices().size() &gt; 1) {</span>
<span class="nc" id="L399">            		content.putString(&quot;List&quot;);</span>
<span class="nc" id="L400">                    db.setContent(content);</span>
<span class="nc" id="L401">                	MusicPlayer.setDraggedItem(songTable.getSelectionModel().getSelectedItems());</span>
            	} else {
<span class="nc" id="L403">            		content.putString(&quot;Song&quot;);</span>
<span class="nc" id="L404">                    db.setContent(content);</span>
<span class="nc" id="L405">                	MusicPlayer.setDraggedItem(row.getItem());</span>
            	}
<span class="nc" id="L407">            	ImageView image = new ImageView(row.snapshot(null, null));</span>
<span class="nc" id="L408">            	Rectangle2D rectangle = new Rectangle2D(0, 0, 250, 50);</span>
<span class="nc" id="L409">            	image.setViewport(rectangle);</span>
<span class="nc" id="L410">            	db.setDragView(image.snapshot(null, null), 125, 25);</span>
<span class="nc" id="L411">                event.consume();</span>
<span class="nc" id="L412">            });</span>

<span class="nc" id="L414">            return row ;</span>
        });
        
<span class="nc" id="L417">        songTable.getSelectionModel().selectedItemProperty().addListener((obs, oldSelection, newSelection) -&gt; {</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">        	if (oldSelection != null) {</span>
<span class="nc" id="L419">        		oldSelection.setSelected(false);</span>
        	}
<span class="nc bnc" id="L421" title="All 4 branches missed.">        	if (newSelection != null &amp;&amp; songTable.getSelectionModel().getSelectedIndices().size() == 1) {</span>
<span class="nc" id="L422">        		newSelection.setSelected(true);</span>
<span class="nc" id="L423">        		selectedSong = newSelection;</span>
        	}
<span class="nc" id="L425">        });</span>
        
        // Plays selected song when enter key is pressed.
<span class="nc" id="L428">        songTable.setOnKeyPressed(event -&gt; {</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">        	if (event.getCode().equals(KeyCode.ENTER)) {</span>
<span class="nc" id="L430">        		play();</span>
        	}
<span class="nc" id="L432">        });</span>
        
<span class="nc" id="L434">        artistList.setMinHeight(0);</span>
<span class="nc" id="L435">        artistList.setPrefHeight(0);</span>
<span class="nc" id="L436">        double height = artists.size() * 50;</span>
<span class="nc" id="L437">        Animation artistListLoadAnimation = new Transition() {</span>
        	{
<span class="nc" id="L439">        		setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L440">                setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L441">        	}</span>
        	
        	protected void interpolate(double frac) {
<span class="nc" id="L444">        		artistList.setMinHeight(frac * height);</span>
<span class="nc" id="L445">        		artistList.setPrefHeight(frac * height);</span>
<span class="nc" id="L446">        	}</span>
        };
<span class="nc" id="L448">        artistListLoadAnimation.play();</span>
<span class="nc" id="L449">    }</span>

    void selectAlbum(Album album) {

<span class="nc bnc" id="L453" title="All 2 branches missed.">        if (selectedAlbum == album) {</span>

<span class="nc" id="L455">            albumList.getSelectionModel().clearSelection();</span>
<span class="nc" id="L456">            showAllSongs(artistList.getSelectionModel().getSelectedItem(), false);</span>

        } else {
        	
<span class="nc bnc" id="L460" title="All 2 branches missed.">        	if (selectedSong != null) {</span>
<span class="nc" id="L461">        		selectedSong.setSelected(false);</span>
        	}
<span class="nc" id="L463">        	selectedSong = null;</span>
<span class="nc" id="L464">            selectedAlbum = album;</span>
<span class="nc" id="L465">            albumList.getSelectionModel().select(selectedAlbum);</span>
<span class="nc" id="L466">            ObservableList&lt;Song&gt; songs = FXCollections.observableArrayList();</span>
<span class="nc" id="L467">            songs.addAll(album.getSongs());</span>
<span class="nc" id="L468">            Collections.sort(songs);</span>
<span class="nc" id="L469">            songTable.getSelectionModel().clearSelection();</span>
<span class="nc" id="L470">            songTable.setItems(songs);</span>
<span class="nc" id="L471">            scrollPane.setVvalue(0);</span>
<span class="nc" id="L472">            albumLabel.setText(album.getTitle());</span>
<span class="nc" id="L473">            songTable.setMinHeight(0);</span>
<span class="nc" id="L474">            songTable.setPrefHeight(0);</span>
<span class="nc" id="L475">            songTable.setVisible(true);</span>
<span class="nc" id="L476">            double height = (songs.size() + 1) * 50 + 2;</span>
<span class="nc" id="L477">            Animation songTableLoadAnimation = new Transition() {</span>
            	{
<span class="nc" id="L479">            		setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L480">                    setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L481">            	}</span>
            	
            	protected void interpolate(double frac) {
<span class="nc" id="L484">            		songTable.setMinHeight(frac * height);</span>
<span class="nc" id="L485">                    songTable.setPrefHeight(frac * height);</span>
<span class="nc" id="L486">            	}</span>
            };
<span class="nc" id="L488">            new Thread(() -&gt; {</span>
            	try {
<span class="nc" id="L490">					loadedLatch.await();</span>
<span class="nc" id="L491">					loadedLatch = new CountDownLatch(1);</span>
<span class="nc" id="L492">				} catch (Exception e) {</span>
<span class="nc" id="L493">					e.printStackTrace();</span>
<span class="nc" id="L494">				}</span>
<span class="nc" id="L495">            	songTableLoadAnimation.play();</span>
<span class="nc" id="L496">            }).start();</span>
        }
<span class="nc" id="L498">    }</span>
    
    void selectArtist(Artist artist) {
    	
<span class="nc" id="L502">    	selectedArtist = artist;</span>
<span class="nc" id="L503">        artistList.getSelectionModel().select(artist);</span>
<span class="nc" id="L504">        CountDownLatch latch = new CountDownLatch(1);</span>
<span class="nc" id="L505">        artistListScrollPane.heightProperty().addListener((x, y, z) -&gt; {</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">        	if (z.doubleValue() != 0) {</span>
<span class="nc" id="L507">        		latch.countDown();</span>
        	}
<span class="nc" id="L509">        });</span>
<span class="nc" id="L510">        new Thread(() -&gt; {</span>
            try {
<span class="nc" id="L512">				latch.await();</span>
<span class="nc" id="L513">				int selectedCell = artistList.getSelectionModel().getSelectedIndex();</span>
<span class="nc" id="L514">	            double vValue = (selectedCell * 50) / (Library.getArtists().size() * 50 - artistListScrollPane.getHeight());</span>
<span class="nc" id="L515">	            artistListScrollPane.setVvalue(vValue);</span>
<span class="nc" id="L516">			} catch (Exception e) {</span>
<span class="nc" id="L517">				e.printStackTrace();</span>
<span class="nc" id="L518">			}</span>
<span class="nc" id="L519">        }).start();</span>
<span class="nc" id="L520">        showAllSongs(artist, true);</span>
<span class="nc" id="L521">        albumList.setPrefWidth(artist.getAlbums().size() * 150 + 2);</span>
<span class="nc" id="L522">        albumList.setMaxWidth(artist.getAlbums().size() * 150 + 2);</span>
<span class="nc" id="L523">        artistLabel.setText(artist.getTitle());</span>
<span class="nc" id="L524">        separator.setVisible(true);</span>
<span class="nc" id="L525">    }</span>
    
    void selectSong(Song song) {
    	
<span class="nc" id="L529">    	new Thread(() -&gt; {</span>
            try {
<span class="nc" id="L531">				loadedLatch.await();</span>
<span class="nc" id="L532">				loadedLatch = new CountDownLatch(1);</span>
<span class="nc" id="L533">				Platform.runLater(() -&gt; {</span>
<span class="nc" id="L534">					songTable.getSelectionModel().select(song);</span>
<span class="nc" id="L535">			        scrollPane.requestFocus();</span>
<span class="nc" id="L536">				});</span>
<span class="nc" id="L537">			} catch (Exception e) {</span>
<span class="nc" id="L538">				e.printStackTrace();</span>
<span class="nc" id="L539">			}</span>
<span class="nc" id="L540">        }).start();</span>
<span class="nc" id="L541">    }</span>
    
    public Song getSelectedSong() {
<span class="nc" id="L544">    	return selectedSong;</span>
    }

    private void showAllSongs(Artist artist, boolean fromMainController) {

<span class="nc" id="L549">        ObservableList&lt;Album&gt; albums = FXCollections.observableArrayList();</span>
<span class="nc" id="L550">        ObservableList&lt;Song&gt; songs = FXCollections.observableArrayList();</span>

<span class="nc bnc" id="L552" title="All 2 branches missed.">        for (Album album : artist.getAlbums()) {</span>

<span class="nc" id="L554">            albums.add(album);</span>

<span class="nc" id="L556">            songs.addAll(album.getSongs());</span>
<span class="nc" id="L557">        }</span>

<span class="nc" id="L559">        Collections.sort(songs, (first, second) -&gt; {</span>

<span class="nc" id="L561">            Album firstAlbum = albums.stream().filter(x -&gt; x.getTitle().equals(first.getAlbum())).findFirst().get();</span>
<span class="nc" id="L562">            Album secondAlbum = albums.stream().filter(x -&gt; x.getTitle().equals(second.getAlbum())).findFirst().get();</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">            if (firstAlbum.compareTo(secondAlbum) != 0) {</span>
<span class="nc" id="L564">                return firstAlbum.compareTo(secondAlbum);</span>
            } else {
<span class="nc" id="L566">                return first.compareTo(second);</span>
            }
        });

<span class="nc" id="L570">        Collections.sort(albums);</span>

<span class="nc bnc" id="L572" title="All 2 branches missed.">        if (selectedSong != null) {</span>
<span class="nc" id="L573">        	selectedSong.setSelected(false);</span>
        }
<span class="nc" id="L575">        selectedSong = null;</span>
<span class="nc" id="L576">    	selectedAlbum = null;</span>
<span class="nc" id="L577">        albumList.getSelectionModel().clearSelection();</span>
<span class="nc" id="L578">        albumList.setItems(albums);</span>
<span class="nc" id="L579">        songTable.setItems(songs);</span>
<span class="nc" id="L580">        songTable.getSelectionModel().clearSelection();</span>
<span class="nc" id="L581">        scrollPane.setVvalue(0);</span>
<span class="nc" id="L582">        albumLabel.setText(&quot;All Songs&quot;);</span>
<span class="nc" id="L583">        songTable.setMinHeight(0);</span>
<span class="nc" id="L584">        songTable.setPrefHeight(0);</span>
<span class="nc" id="L585">        songTable.setVisible(true);</span>
<span class="nc" id="L586">        double height = (songs.size() + 1) * 50 + 2;</span>
<span class="nc" id="L587">        Animation songTableLoadAnimation = new Transition() {</span>
        	{
<span class="nc" id="L589">        		setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L590">                setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L591">        	}</span>
        	
        	protected void interpolate(double frac) {
<span class="nc" id="L594">        		songTable.setMinHeight(frac * height);</span>
<span class="nc" id="L595">                songTable.setPrefHeight(frac * height);</span>
<span class="nc" id="L596">        	}</span>
        };
        
<span class="nc" id="L599">        songTableLoadAnimation.setOnFinished(x -&gt; loadedLatch.countDown());</span>
        
<span class="nc" id="L601">        new Thread(() -&gt; {</span>
        	try {
<span class="nc bnc" id="L603" title="All 2 branches missed.">        		if (fromMainController) {</span>
<span class="nc" id="L604">        			MusicPlayer.getMainController().getLatch().await();</span>
<span class="nc" id="L605">        			MusicPlayer.getMainController().resetLatch();</span>
        		} else {
<span class="nc" id="L607">        			loadedLatch.await();</span>
<span class="nc" id="L608">        			loadedLatch = new CountDownLatch(1);</span>
        		}
<span class="nc" id="L610">			} catch (Exception e) {</span>
<span class="nc" id="L611">				e.printStackTrace();</span>
<span class="nc" id="L612">			}</span>
<span class="nc" id="L613">			songTableLoadAnimation.play();</span>
<span class="nc" id="L614">        }).start();</span>
<span class="nc" id="L615">    }</span>
    
    @Override
    public void play() {
    	
<span class="nc" id="L620">    	Song song = selectedSong;</span>
<span class="nc" id="L621">        ArrayList&lt;Song&gt; songs = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L623" title="All 2 branches missed.">        if (selectedAlbum != null) {</span>
<span class="nc" id="L624">            songs.addAll(selectedAlbum.getSongs());</span>
        } else {
<span class="nc bnc" id="L626" title="All 2 branches missed.">            for (Album album : selectedArtist.getAlbums()) {</span>
<span class="nc" id="L627">                songs.addAll(album.getSongs());</span>
<span class="nc" id="L628">            }</span>
        }
        
<span class="nc bnc" id="L631" title="All 2 branches missed.">        if (MusicPlayer.isShuffleActive()) {</span>
<span class="nc" id="L632">        	Collections.shuffle(songs);</span>
<span class="nc" id="L633">        	songs.remove(song);</span>
<span class="nc" id="L634">        	songs.add(0, song);</span>
        } else {
<span class="nc" id="L636">        	Collections.sort(songs, (first, second) -&gt; {</span>

<span class="nc" id="L638">                Album firstAlbum = Library.getAlbum(first.getAlbum());</span>
<span class="nc" id="L639">                Album secondAlbum = Library.getAlbum(second.getAlbum());</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">                if (firstAlbum.compareTo(secondAlbum) != 0) {</span>
<span class="nc" id="L641">                    return firstAlbum.compareTo(secondAlbum);</span>
                } else {
<span class="nc" id="L643">                    return first.compareTo(second);</span>
                }
            });
        }

<span class="nc" id="L648">        MusicPlayer.setNowPlayingList(songs);</span>
<span class="nc" id="L649">        MusicPlayer.setNowPlaying(song);</span>
<span class="nc" id="L650">        MusicPlayer.play();</span>
<span class="nc" id="L651">    }</span>
    
    @Override
    public void scroll(char letter) {
    	
<span class="nc" id="L656">    	ObservableList&lt;Artist&gt; artistListItems = artistList.getItems();</span>
    	
<span class="nc" id="L658">    	int selectedCell = 0;</span>

<span class="nc bnc" id="L660" title="All 2 branches missed.">        for (Artist artist : artistListItems) {</span>
            // Removes article from artist title and compares it to selected letter.
<span class="nc" id="L662">            String artistTitle = artist.getTitle();</span>
<span class="nc" id="L663">            char firstLetter = removeArticle(artistTitle).charAt(0);</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">            if (firstLetter &lt; letter) {</span>
<span class="nc" id="L665">                selectedCell++;</span>
            }
<span class="nc" id="L667">        }</span>
    	
<span class="nc" id="L669">    	double startVvalue = artistListScrollPane.getVvalue();</span>
<span class="nc" id="L670">    	double finalVvalue = (double) (selectedCell * 50) / (Library.getArtists().size() * 50 - artistListScrollPane.getHeight());</span>
    	
<span class="nc" id="L672">    	Animation scrollAnimation = new Transition() {</span>
            {
<span class="nc" id="L674">                setCycleDuration(Duration.millis(500));</span>
<span class="nc" id="L675">            }</span>
            protected void interpolate(double frac) {
<span class="nc" id="L677">                double vValue = startVvalue + ((finalVvalue - startVvalue) * frac);</span>
<span class="nc" id="L678">                artistListScrollPane.setVvalue(vValue);</span>
<span class="nc" id="L679">            }</span>
        };
<span class="nc" id="L681">        scrollAnimation.play();</span>
<span class="nc" id="L682">    }</span>
    
    private String removeArticle(String title) {

<span class="nc" id="L686">        String arr[] = title.split(&quot; &quot;, 2);</span>

<span class="nc bnc" id="L688" title="All 2 branches missed.">        if (arr.length &lt; 2) {</span>
<span class="nc" id="L689">            return title;</span>
        } else {

<span class="nc" id="L692">            String firstWord = arr[0];</span>
<span class="nc" id="L693">            String theRest = arr[1];</span>

<span class="nc bnc" id="L695" title="All 2 branches missed.">            switch (firstWord) {</span>
                case &quot;A&quot;:
                case &quot;An&quot;:
                case &quot;The&quot;:
<span class="nc" id="L699">                    return theRest;</span>
                default:
<span class="nc" id="L701">                    return title;</span>
            }
        }
    }
    
<span class="nc" id="L706">    private Animation artistLoadAnimation = new Transition() {</span>
        {
<span class="nc" id="L708">            setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L709">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L710">        }</span>
        protected void interpolate(double frac) {
<span class="nc" id="L712">            double curHeight = collapsedHeight + (expandedHeight - collapsedHeight) * (frac);</span>
<span class="nc" id="L713">            subViewRoot.setTranslateY(expandedHeight - curHeight);</span>
<span class="nc" id="L714">            subViewRoot.setOpacity(frac);</span>
<span class="nc" id="L715">        }</span>
    };
    
<span class="nc" id="L718">    private Animation artistUnloadAnimation = new Transition() {</span>
        {
<span class="nc" id="L720">            setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L721">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L722">        }</span>
        protected void interpolate(double frac) {
<span class="nc" id="L724">            double curHeight = collapsedHeight + (expandedHeight - collapsedHeight) * (1 - frac);</span>
<span class="nc" id="L725">            subViewRoot.setTranslateY(expandedHeight - curHeight);</span>
<span class="nc" id="L726">            subViewRoot.setOpacity(1 - frac);</span>
<span class="nc" id="L727">        }</span>
    };

<span class="nc" id="L730">    private Animation albumLoadAnimation = new Transition() {</span>
        {
<span class="nc" id="L732">            setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L733">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L734">        }</span>
        protected void interpolate(double frac) {
<span class="nc" id="L736">            double curHeight = collapsedHeight + (expandedHeight - collapsedHeight) * (frac);</span>
<span class="nc" id="L737">            songTable.setTranslateY(expandedHeight - curHeight);</span>
<span class="nc" id="L738">            songTable.setOpacity(frac);</span>
<span class="nc" id="L739">        }</span>
    };
    
<span class="nc" id="L742">    private Animation albumUnloadAnimation = new Transition() {</span>
        {
<span class="nc" id="L744">            setCycleDuration(Duration.millis(250));</span>
<span class="nc" id="L745">            setInterpolator(Interpolator.EASE_BOTH);</span>
<span class="nc" id="L746">        }</span>
        protected void interpolate(double frac) {
<span class="nc" id="L748">            double curHeight = collapsedHeight + (expandedHeight - collapsedHeight) * (1 - frac);</span>
<span class="nc" id="L749">            songTable.setTranslateY(expandedHeight - curHeight);</span>
<span class="nc" id="L750">            songTable.setOpacity(1 - frac);</span>
<span class="nc" id="L751">            songTable.setMinHeight(1 - frac);</span>
<span class="nc" id="L752">            songTable.setPrefHeight(1 - frac);</span>
<span class="nc" id="L753">        }</span>
    };
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>